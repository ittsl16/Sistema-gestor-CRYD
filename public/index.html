<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gestor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <script>
        // Firebase configuration (pasted by user)
        const firebaseConfig = {
            apiKey: "AIzaSyCSjJjaDkiDFLCYqr3uP1fKW5H3HCnTmKg",
            authDomain: "cryd-production.firebaseapp.com",
            projectId: "cryd-production",
            storageBucket: "cryd-production.firebasestorage.app",
            messagingSenderId: "194421485008",
            appId: "1:194421485008:web:bc3b89cd9a4550a5759dd5",
            measurementId: "G-9PKTXYVRHN"
        };

        function initFirebase(){
            try{
                if (!window.firebaseInitialized) {
                    firebase.initializeApp(firebaseConfig);
                    // Firestore (compat)
                    window.db = firebase.firestore();
                    // Auth (compat)
                    window.auth = firebase.auth();
                    // Storage (compat)
                    window.storage = firebase.storage();
                    // Functions (compat)
                    try { window.functions = firebase.functions(); } catch (e) { console.warn('functions init failed', e); }
                    window.firebaseInitialized = true;
                    console.log('Firebase initialized');
                    // Warn if running from file:// protocol since some browser features (cookies, auth) will be limited
                    if (location && location.protocol === 'file:') {
                        console.warn('Running from file:// - some features (cookies, auth) may not behave as expected. Use a local server (e.g. python -m http.server) or Firebase Hosting for full functionality.');
                    }
                    try { window.analytics = firebase.analytics(); console.log('Analytics initialized'); } catch (e) { console.warn('Analytics init failed', e); }

                    // Try to enable offline persistence (optional)
                    try {
                        window.db.enablePersistence()
                            .then(() => console.log('Firestore persistence enabled'))
                            .catch((e) => console.warn('Could not enable persistence', e));
                    } catch (e) { console.warn('enablePersistence not available', e); }
                }
            } catch (e) {
                console.warn('Firebase init error', e);
            }
        }

        // Validaci√≥n remota: comprueba si existe un documento de usuario en la colecci√≥n 'users'
        // docId = userId (coincidente con ID textual en la app). La colecci√≥n 'users' debe contener campos: role: 'admin'|'coordinator', cuadrilla: 'cuadrilla-a'|'mixto'|'cuadrilla-b'|'cuadrilla-c'
        async function validateCredentialsRemote(userId, type) {
            if (!window.firebaseInitialized || !window.db) return false;
            try {
                const doc = await window.db.collection('users').doc(userId).get();
                if (!doc.exists) return false;
                const data = doc.data();
                if (!data || !data.role) return false;
                if (type === 'admin' && data.role === 'admin') return true;
                if (type === 'coordinator' && data.role === 'coordinator') return true;
                return false;
            } catch (e) {
                if (e && e.code === 'permission-denied') {
                    console.warn('validateCredentialsRemote permission-denied: Ensure Cloud Firestore API is enabled for your project and that your security rules permit reads.');
                } else if (e && e.message && e.message.indexOf('offline') !== -1) {
                    console.warn('validateCredentialsRemote error: client appears to be offline or cannot reach Firestore backend. Check internet connectivity or Firestore API status.');
                } else {
                    console.warn('validateCredentialsRemote error', e);
                }
                return false;
            }
        }

        // Sincroniza datos locales a Firestore cuando hay conexi√≥n. Intenta subir shiftData y hourlyData.
        async function syncLocalToFirestore() {
            if (!window.firebaseInitialized || !window.db) return;
            try {
                const shiftData = JSON.parse(localStorage.getItem('shiftData') || '{}');
                const hourlyData = JSON.parse(localStorage.getItem('hourlyData') || '{}');
                const promises = [];
                Object.keys(shiftData).forEach(date => {
                    promises.push(window.db.collection('shifts').doc(date).set(shiftData[date], { merge: true }));
                });
                Object.keys(hourlyData).forEach(date => {
                    // hourlyData[date] expected shape: { cuadrilla: [entries] }
                    promises.push(window.db.collection('hourly').doc(date).set(hourlyData[date], { merge: true }));
                });
                await Promise.all(promises);
                console.log('Local data synced to Firestore');
            } catch (e) {
                console.warn('syncLocalToFirestore error', e);
            }
        }

        // Listeners en vivo (admin): suscribirse a cambios en hoy -> actualiza dashboard en tiempo real
        let _firebaseUnsubscribe = { shifts: null, hourly: null };
        function startLiveFirestoreListeners() {
            if (!window.firebaseInitialized || !window.db) return;
            const today = new Date().toISOString().split('T')[0];
            try {
                // Unsubscribe previous
                if (_firebaseUnsubscribe.shifts) _firebaseUnsubscribe.shifts();
                if (_firebaseUnsubscribe.hourly) _firebaseUnsubscribe.hourly();

                _firebaseUnsubscribe.shifts = window.db.collection('shifts').doc(today).onSnapshot(doc => {
                    // Actualiza dashboard con datos remotos
                    console.log('shifts snapshot updated');
                    updateAdminDashboard();
                }, err => console.warn('shifts snapshot err', err));

                _firebaseUnsubscribe.hourly = window.db.collection('hourly').doc(today).onSnapshot(doc => {
                    console.log('hourly snapshot updated');
                    updateAdminDashboard();
                }, err => console.warn('hourly snapshot err', err));
            } catch (e) {
                console.warn('startLiveFirestoreListeners error', e);
            }
        }

        function stopLiveFirestoreListeners() {
            if (_firebaseUnsubscribe.shifts) _firebaseUnsubscribe.shifts();
            if (_firebaseUnsubscribe.hourly) _firebaseUnsubscribe.hourly();
            _firebaseUnsubscribe.shifts = null; _firebaseUnsubscribe.hourly = null;
        }

        // Upload a Blob or File to Firebase Storage and return the download URL.
        async function uploadFileToFirebase(blobOrFile, path) {
            if (!window.firebaseInitialized || !window.storage) throw new Error('Firebase Storage not initialized');
            try {
                const storageRef = window.storage.ref();
                const fileRef = storageRef.child(path);
                const snapshot = await fileRef.put(blobOrFile);
                const url = await snapshot.ref.getDownloadURL();
                return url;
            } catch (e) {
                console.warn('uploadFileToFirebase error', e);
                throw e;
            }
        }
    </script>
    <style>
        :root {
            --primary-color: #CF002E; /* rojo primario */
            --secondary-color: #FDD000; /* amarillo primario */
            --primary-dark: #a20028;
            --secondary-dark: #b88f00;
            --muted: #8f8e81; /* gris neutro */
            --muted-dark: #333333; /* gris oscuro / casi negro */
            --warning-bg: rgba(253, 208, 0, 0.08); /* amarillo suave */
            --warning-border: rgba(253, 208, 0, 0.22);
            --success-bg: rgba(207, 0, 46, 0.06); /* usa tonalidad roja sutil */
            --success-border: rgba(207, 0, 46, 0.14);
            --low-bg: rgba(207, 0, 46, 0.04);
            --danger-color: #CF002E;
            --accent-color: #CF002E; /* acento en rojo */
            --light-color: #ffffff; /* blanco */
            --success-color: #CF002E; /* reutiliza rojo para indicadores */
            --warning-color: #FDD000; /* amarillo para warnings */
            --admin-color: #333333; /* gris oscuro para el dashboard */
            --turno1-color: #CF002E;
            --turno2-color: #FDD000;
            --turno3-color: #CF002E;
            --turno-mixto-color: #333333; /* mixto en gris oscuro */
            --cuadrilla-a-color: #CF002E; /* usar rojo/amarillo/gris √∫nicamente */
            --cuadrilla-b-color: #FDD000;
            --cuadrilla-c-color: #505050;
        }
        /* Delivery font: regular/bold/light (add font files under fonts/ if you have them) */
        @font-face {
            font-family: 'Delivery';
            src: local('Delivery'), url('fonts/delivery-regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Delivery';
            src: local('Delivery Bold'), url('fonts/delivery-bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Delivery';
            src: local('Delivery Light'), url('fonts/delivery-light.woff2') format('woff2');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Delivery', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Delivery typographic helpers */
        .delivery-regular { font-family: 'Delivery', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 400; }
        .delivery-bold { font-family: 'Delivery', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 700; }
        .delivery-light { font-family: 'Delivery', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 300; }
        
        body {
            background-color: #ffffff;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: #fff; /* texto blanco sobre fondo rojo */
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: 700;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-badge {
            background-color: var(--secondary-color);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .user-badge.admin {
            background-color: var(--admin-color);
        }
        
        .user-badge.mixto {
            background-color: var(--turno-mixto-color);
        }
        
        .user-badge.cuadrilla-a {
            background-color: var(--cuadrilla-a-color);
        }
        
        .user-badge.cuadrilla-b {
            background-color: var(--cuadrilla-b-color);
        }
        
        .user-badge.cuadrilla-c {
            background-color: var(--cuadrilla-c-color);
        }
        
        .logout-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-family: 'Delivery', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 700;
        }
        
        .user-type-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .user-type {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: background-color 0.3s;
        }
        
        .user-type.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .user-type.admin.active {
            background-color: var(--admin-color);
        }
        
        .nav-tabs {
            display: flex;
            background-color: var(--light-color);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
            flex: 1;
        }
        
        .tab.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .tab.admin-only {
            background-color: var(--admin-color);
            color: white;
        }
        
        .tab:hover:not(.active) {
            background-color: #d6dbdf;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--secondary-color);
            color: var(--muted-dark);
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--secondary-dark);
            color: var(--muted-dark);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .chart-container {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
            color: var(--primary-color);
        }
        
        .attendance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }

        /* Admin status indicators for summary cards */
        .summary-card.status-low {
            border-left: 4px solid var(--accent-color);
            background-color: var(--low-bg);
        }
        .summary-card.status-ok {
            border-left: 4px solid var(--warning-color);
            background-color: var(--warning-bg);
        }
        .summary-card.status-success {
            border-left: 4px solid var(--success-color);
            background-color: var(--success-bg);
        }

        /* Status classes for linear summary rows */
        .linear-summary-table tr.status-low td { background-color: var(--low-bg); border-left: 4px solid var(--accent-color); }
        .linear-summary-table tr.status-ok td { background-color: var(--warning-bg); border-left: 4px solid var(--warning-color); }
        .linear-summary-table tr.status-success td { background-color: var(--success-bg); border-left: 4px solid var(--success-color); }

        /* Active row highlighting */
        .linear-summary-table tr.active-row td { outline: 2px solid rgba(0,0,0,0.06); box-shadow: inset 0 0 0 2px rgba(0,0,0,0.03); }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .present {
            color: var(--success-color);
        }
        
        .absent {
            color: var(--accent-color);
        }
        
        .progress-container {
            margin-top: 20px;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.5s;
        }

        /* Linear admin summary styles */
        .linear-summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            background-color: rgb(255, 255, 255);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-radius: 6px;
            overflow: hidden;
        }
        .linear-summary-table th, .linear-summary-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        .progress-mini {
            height: 14px;
            width: 100%;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-mini-fill {
            height: 100%;
            width: 0%;
            transition: width 0.5s;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        
        .hourly-entry {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        
        .hourly-entry:last-child {
            border-bottom: none;
        }
        
        .time-stamp {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .access-denied {
            text-align: center;
            padding: 40px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .access-denied h2 {
            color: var(--accent-color);
            margin-bottom: 15px;
        }
        
        .export-section {
            margin-top: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            background-color: var(--secondary-color);
            color: var(--muted-dark);
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .export-btn:hover {
            background-color: var(--secondary-dark);
            color: var(--muted-dark);
        }

        .export-btn.excel {
            background-color: var(--accent-color); /* rojo */
            color: #fff;
        }

        .export-btn.excel:hover {
            background-color: var(--primary-dark);
        }
        
        .data-preview {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #e9ecef;
            position: sticky;
            top: 0;
        }
        
        .last-export {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .attendance-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .attendance-card h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .time-limit {
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .time-limit.expired {
            background-color: var(--primary-color);
            border-color: var(--primary-dark);
            color: #fff;
        }
        
        .alert-banner {
            background-color: var(--primary-color);
            border: 1px solid var(--primary-dark);
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-banner button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .alert-banner button:hover { background-color: var(--primary-dark); }
        
        .turno-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .turno-1 { background-color: var(--turno1-color); }
        .turno-2 { background-color: var(--turno2-color); }
        .turno-3 { background-color: var(--turno3-color); }
        .turno-mixto { background-color: var(--turno-mixto-color); }
        .cuadrilla-a { background-color: var(--cuadrilla-a-color); }
        .cuadrilla-b { background-color: var(--cuadrilla-b-color); }
        .cuadrilla-c { background-color: var(--cuadrilla-c-color); }
        
        .efficiency-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .efficiency-high { background-color: var(--secondary-color); color: #222; }
        .efficiency-medium { background-color: var(--warning-bg); color: #333; }
        .efficiency-low { background-color: var(--primary-color); color: #fff; }
        .summary-efficiency { display:inline-block; margin-top:8px; padding:6px 10px; border-radius:6px; font-weight:700; }
        
        .admin-dashboard {
            /* Fondo m√°s contrastado usando rojo primario con acento amarillo sutil */
            background: linear-gradient(135deg, var(--primary-dark) 0%, #CF002E 40%, rgba(253,208,0,0.12) 100%);
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .admin-stat-card {
            /* Tarjetas internas en blanco para legibilidad del contenido */
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: #222; /* texto oscuro dentro de tarjetas */
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .admin-stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .mixto-info {
            background: linear-gradient(135deg, var(--primary-dark) 0%, rgba(253,208,0,0.08) 100%);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .mixto-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .mixto-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }
        
        .cuadrilla-info {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%);
            color: #222;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .cuadrilla-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .cuadrilla-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }
        
        .success-banner {
            background-color: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
            color: var(--success-color);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .warning-banner {
            background-color: rgba(253, 208, 0, 0.12);
            border: 1px solid rgba(253, 208, 0, 0.3);
            color: var(--warning-color);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Adjust banners within data tables */
        .data-table .success-banner, .data-table .warning-banner {
            padding: 6px;
            margin: 0;
            font-size: 0.85rem;
            border-radius: 4px;
            text-align: center;
        }
        
        .late-registration {
            background-color: rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.06);
            color: #383d41;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        /* Missing profiles (Admin alerts) */
        .missing-profiles .remind-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
        }

        .missing-profiles .remind-btn:hover {
            background-color: var(--primary-dark); /* darken primary for hover */
        }

        .missing-profiles .dismiss-profile {
            background-color: var(--muted);
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 6px;
        }

        .missing-profiles .dismiss-profile:hover {
            background-color: var(--muted-dark);
        }

        .missing-profiles { margin-top: 10px; }
        
        .late-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        .live-badge {
            display: inline-block;
            background: var(--success-color);
            color: #fff;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            vertical-align: middle;
        }
        .tardy-details {
            margin-top: 10px;
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            padding: 8px;
            border-radius: 6px;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .attendance-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .mixto-stats {
                grid-template-columns: 1fr;
            }
            
            .cuadrilla-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="login-screen" class="login-container">
        <h2 class="login-title">Sistema Gestor</h2>
        <div class="user-type-selector">
            <div class="user-type active" data-type="coordinator">Coordinador</div>
            <div class="user-type" data-type="admin">Administrador</div>
        </div>
        <div class="form-group">
            <label for="user-id">ID de Usuario</label>
            <input type="text" id="user-id" placeholder="Ingrese su ID">
        </div>
        <!-- Session persistence: disabled by default (sessionStorage only) -->
        <div class="form-group">
            <label for="password">Contrase√±a</label>
            <input type="password" id="password" placeholder="Ingrese su contrase√±a">
        </div>
        <button id="login-btn">Ingresar al Sistema</button>
    </div>
    <!-- Sistema Principal (oculto inicialmente) -->
    <div id="main-system" style="display: none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <h1>Sistema Gestor</h1>
                    <div class="user-info">
                        <span class="user-badge" id="user-badge">Coordinador</span>
                        <span id="admin-live-badge" class="live-badge" style="display:none; margin-left:8px;">En vivo</span>
                        <span id="user-id-display">ID: </span>
                        <span id="current-time-display"></span>
                        <button class="logout-btn" id="logout-btn">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="container">
            <!-- Alertas para administrador -->
            <div id="admin-alerts" style="display: none;"></div>
            
            <!-- Navegaci√≥n para Coordinadores -->
            <div id="coordinator-tabs" class="nav-tabs" style="display: none;">
                <div class="tab active" data-tab="start-shift">Inicio de Turno</div>
                <div class="tab" data-tab="hourly-tracking">Seguimiento Horario</div>
                <div class="tab" data-tab="progress-view">Progreso</div>
            </div>
            
            <!-- Navegaci√≥n para Administradores -->
            <div id="admin-tabs" class="nav-tabs" style="display: none;">
                <div class="tab admin-only active" data-tab="dashboard">Dashboard</div>
            </div>
            
            <!-- Contenido para Coordinadores -->
            <div id="coordinator-content">
                <!-- Informaci√≥n del Turno Mixto -->
                <div id="mixto-info" class="mixto-info" style="display: none;">
                    <h3>üìä Turno Mixto</h3> 
                    <p>Acceso a la supervisi√≥n de los turnos</p>
                    <div class="mixto-stats">
                        <div class="mixto-stat">
                            <div>Turno 1</div>
                            <div class="summary-value" style="color: var(--turno1-color)" id="mixto-turno1">0</div>
                        </div>
                        <div class="mixto-stat">
                            <div>Turno 2</div>
                            <div class="summary-value" style="color: var(--turno2-color)" id="mixto-turno2">0</div>
                        </div>
                        <div class="mixto-stat">
                            <div>Turno 3</div>
                            <div class="summary-value" style="color: var(--turno3-color)" id="mixto-turno3">0</div>
                        </div>
                        <div class="mixto-stat">
                            <div>Total D√≠a</div>
                            <div class="summary-value" style="color: white" id="mixto-total">0</div>
                        </div>
                    </div>
                    <div class="admin-extra-breakdown" style="margin-top:10px; display:none;" id="admin-extra-breakdown">
                        <h4>Desglose Personal Extra</h4>
                        <div id="admin-extra-breakdown-content">No hay personal extra</div>
                    </div>
                </div>
                
                <!-- Informaci√≥n de Cuadrilla -->
                <div id="cuadrilla-info" class="cuadrilla-info" style="display: none;">
                    <h3>üìã Informaci√≥n de Cuadrilla</h3> 
                    <p id="cuadrilla-description">Cuadrilla A - Turno 1 (06:00 - 13:00)</p>
                    <div class="cuadrilla-stats">
                        <div class="cuadrilla-stat">
                            <div>Cuadrilla</div>
                            <div class="summary-value" id="cuadrilla-name">A</div>
                        </div>
                        <div class="cuadrilla-stat">
                            <div>Turno Actual</div>
                            <div class="summary-value" id="cuadrilla-turno">1</div>
                        </div>
                        <div class="cuadrilla-stat">
                            <div>Horario</div>
                            <div class="summary-value" id="cuadrilla-horario">06:00 - 13:00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Formulario de Inicio de Turno -->
                <div id="start-shift" class="tab-content active">
                    <h2>Registro de Inicio de Turno</h2>
                    <div id="start-shift-time-limit" class="time-limit">
                        ‚è∞ Tienes 1 hora para registrar el inicio de turno
                    </div>
                    <form id="start-shift-form">
                        <div class="form-group">
                            <label for="coordinator-id">ID del Coordinador</label>
                            <input type="text" id="coordinator-id" readonly>
                        </div>
                        
                        <div class="form-group">
                            <h3>Confirmaci√≥n de Asistencia</h3>
                            <p>Personal total asignado vs personal presente</p>
                            
                            <div class="attendance-grid">
                                <div class="attendance-card">
                                    <h3>Montacarguistas</h3>
                                    <div class="attendance-item">
                                        <span>HC Target:</span>
                                        <strong id="montas-target">0</strong>
                                    </div>
                                    <div class="form-group">
                                        <label for="montas-presentes">Montacarguistas presentes:</label>
                                        <input type="number" id="montas-presentes" min="0" max="20" value="0" required>
                                    </div>
                                </div>

                                 <div class="attendance-card">
                                    <h3>Almacenistas</h3>
                                    <div class="attendance-item">
                                        <span>HC Target:</span>
                                        <strong id="alm-target">0</strong>
                                    </div>
                                    <div class="form-group">
                                        <label for="alm-presentes">Almacenistas presentes:</label>
                                        <input type="number" id="alm-presentes" min="0" max="20" value="0" required>
                                    </div>
                                </div>

                                 <div class="attendance-card">
                                    <h3>Auditores</h3>
                                    <div class="attendance-item">
                                        <span>HC Target:</span>
                                        <strong id="auditores-target">0</strong>
                                    </div>
                                    <div class="form-group">
                                        <label for="auditores-presentes">Auditores presentes:</label>
                                        <input type="number" id="auditores-presentes" min="0" max="20" value="0" required>
                                    </div>
                                </div>

                                <div class="attendance-card">
                                    <h3>Auxiliar administrativo </h3>
                                    <div class="attendance-item">
                                        <span>HC Target:</span>
                                        <strong id="auxiliares-target">0</strong>
                                    </div>
                                    <div class="form-group">
                                        <label for="auxiliares-presentes">Auxiliares presentes:</label>
                                        <input type="number" id="auxiliares-presentes" min="0" max="20" value="0" required>
                                    </div>
                                </div>

                                <!-- Campos adicionales para turno mixto -->
                                <div class="attendance-card" id="analistas-card" style="display: none;">
                                    <h3>Analistas</h3>
                                    <div class="attendance-item">
                                        <span>HC Target:</span>
                                        <strong id="analistas-target">0</strong>
                                    </div>
                                    <div class="form-group">
                                        <label for="analistas-presentes">Analistas presentes:</label>
                                        <input type="number" id="analistas-presentes" min="0" max="5" value="0">
                                    </div>
                                </div>

                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="comentarios-asistencia">Comentarios sobre asistencia (opcional):</label>
                            <textarea id="comentarios-asistencia" placeholder="Ej:Ausencias justificadas, injustificadas, vacaciones etc." rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <h3>Personal Extra</h3>
                            <p>Registre personas que se quedan en turno fuera del asignado. Estas se contabilizar√°n por separado.</p>
                            <p style="font-size:0.9rem; color:#333; margin-top:6px;">
                                <strong>Reglas de Horas Extra:</strong> Cuadrillas A, B y C pueden registrar horas extra el mismo d√≠a (antes o despu√©s del turno), indicando la hora de inicio. La cuadrilla <em>Mixto</em> s√≥lo puede registrar horas extra los s√°bados. Los domingos no se registran horas ni se inicia turno.
                            </p>
                            <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
                                <input type="text" id="extra-name" placeholder="Nombre o ID (opcional)" style="flex:1; min-width:120px;"/>
                                <select id="extra-role">
                                    <option value="montacarguistas">Montacarguista</option>
                                    <option value="almacenistas">Almacenista</option>
                                    <option value="auditores">Auditor</option>
                                    <option value="auxiliares">Auxiliar</option>
                                    <option value="analistas">Analista</option>
                                    <option value="otro">Otro</option>
                                </select>
                                <input type="number" id="extra-hours" min="0" step="0.25" placeholder="Horas permanecidas" style="width:120px;"/>
                                <select id="extra-hour" style="width:110px;">
                                    <option value="">Hora inicio (opcional)</option>
                                </select>
                                <button type="button" id="add-extra-btn" class="export-btn" style="padding:6px 10px">‚ûï Agregar Extra</button>
                            </div>
                            <div id="extra-list" style="background:#fff; padding:8px; border-radius:6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">No hay personal extra registrado</div>
                        </div>
                        
                        <div class="form-group">
                            <h4>Meta ajustada del turno: <span id="meta-turno-ajustada">3000</span> cajas</h4>
                            <p>Basada en el personal presente vs. personal objetivo</p>
                        </div>
                        
                        <button type="submit" id="start-shift-submit">Registrar Inicio de Turno</button>
                    </form>
                </div>

                
                <!-- Formulario de Seguimiento Horario -->
                <div id="hourly-tracking" class="tab-content">
                    <h2>Seguimiento Horario</h2>
                    <div id="hourly-time-limit" class="time-limit">
                        ‚è∞ Tienes hasta 59 minutos despu√©s de cada hora para registrar
                    </div>
                    <div id="late-registration-warning" class="late-registration" style="display: none;">
                        ‚ö†Ô∏è Est√°s registrando datos fuera del tiempo l√≠mite. Esta acci√≥n quedar√° marcada como registro tard√≠o.
                    </div>
                    <div id="lunch-warning" class="warning-banner" style="display:none;">
                        ‚ö†Ô∏è Esta hora contiene un descanso; confirme la intenci√≥n de registrar la hora parcial o ajuste el rango.
                    </div>
                    <form id="hourly-form">
                        <div class="form-group">
                            <label for="hourly-coordinator-id">ID del Coordinador</label>
                            <input type="text" id="hourly-coordinator-id" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="current-hour">Hora a Reportar</label>
                            <select id="current-hour" required>
                                <option value="">Seleccione la hora</option>
                                <!-- Las opciones se generar√°n din√°micamente -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="cajas">Cajas total realizado</label>
                            <input type="number" id="cajas" min="0" required placeholder="Ingrese el total cajas de esta hora">
                        </div>
                        
                        <button type="submit" id="hourly-submit">Registrar datos</button>
                        <button type="button" id="quick-checkin" style="margin-left:8px;">Check-in r√°pido</button>
                    </form>
                    
                    <div class="progress-container">
                        <h3>Progreso del Turno Actual</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span>Actual: <span id="current-count">0</span></span>
                            <span>Meta por turno: <span id="meta-turno-display">3000</span></span>
                        </div>
                        <p>Objetivo por hora: <span id="meta-hora-display">400</span></p>
                    </div>
                    
                    <div id="hourly-entries">
                        <h3>Registros Horarios de Hoy</h3>
                        <!-- Las entradas horarias se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>
                
                <!-- Vista de Progreso (para coordinadores) -->
                <div id="progress-view" class="tab-content">
                    <h2>Progreso de Producci√≥n</h2>
                    <p>Avance de todos los turnos en tiempo real</p>
                    
                    <div class="dashboard">
                        <div class="chart-container">
                            <div class="chart-title">Progreso por Turno</div>
                            <canvas id="turn-progress-chart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">Eficiencia por Hora</div>
                            <canvas id="efficiency-chart"></canvas>
                        </div>
                    </div>
                    <!-- Registros horarios pasados al perfil de Administrador -->
                    
                    <div class="attendance-summary">
                        <div class="summary-card" id="admin-card-turno1">
                            <h4><span class="turno-indicator turno-1"></span>Turno 1 (06:00 - 13:00)</h4>
                            <div class="summary-value" style="color: var(--turno1-color)" id="turno1-progress">0</div>
                            <span>Cajas acumulado</span>
                            <div class="summary-efficiency" id="turno1-efficiency">0%</div>
                            <div id="turno1-meta-status"></div>
                        </div>
                        <div class="summary-card" id="admin-card-turno2">
                            <h4><span class="turno-indicator turno-2"></span>Turno 2 (14:00 - 21:00)</h4>
                            <div class="summary-value" style="color: var(--turno2-color)" id="turno2-progress">0</div>
                            <span>Cajas acumulado</span>
                            <div class="summary-efficiency" id="turno2-efficiency">0%</div>
                            <div id="turno2-meta-status"></div>
                        </div>
                        <div class="summary-card" id="admin-card-turno3">
                            <h4><span class="turno-indicator turno-3"></span>Turno 3 (22:00 - 05:00)</h4>
                            <div class="summary-value" style="color: var(--turno3-color)" id="turno3-progress">0</div>
                            <span>Cajas acumulado</span>
                            <div class="summary-efficiency" id="turno3-efficiency">0%</div>
                            <div id="turno3-meta-status"></div>
                        </div>
                        <div class="summary-card" id="admin-card-turno-mixto">
                            <h4><span class="turno-indicator turno-mixto"></span>Turno Mixto (08:00 - 18:00)</h4>
                            <div class="summary-value" style="color: var(--turno-mixto-color)" id="turno-mixto-progress">0</div>
                            <span>Cajas acumulado</span>
                            <div class="summary-efficiency" id="turno-mixto-efficiency">0%</div>
                            <div id="turno-mixto-meta-status"></div>
                        </div>
                        <div class="summary-card" id="admin-card-total">
                            <h4>Total D√≠a</h4>
                            <div class="summary-value" style="color: var(--primary-color)" id="total-dia-progress">0</div>
                            <span>Cajas total</span>
                            <div id="total-meta-status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contenido para Administradores -->
            <div id="admin-content" style="display: none;">
                <!-- Dashboard (Solo para Administrador) -->
                <div id="dashboard" class="tab-content active">
                    <div class="admin-dashboard">
                        <h2>Dashboard de Gesti√≥n - Administrador</h2>
                        <p>Vista completa del desempe√±o de todos los turnos y cuadrillas</p>
                        
                        <div class="admin-stats">
                            <div class="admin-stat-card">
                                <h4>Producci√≥n Total</h4>
                                <div class="admin-stat-value" id="total-production">0</div>
                                <span>Cajas acumulado</span>
                            </div>
                            <div class="admin-stat-card">
                                <h4>Eficiencia</h4>
                                <div class="admin-stat-value" id="global-efficiency">0%</div>
                                <span>Promedio del d√≠a</span>
                            </div>
                            <div class="admin-stat-card">
                                <h4>Asistencia Total</h4>
                                <div class="admin-stat-value" id="total-attendance">0</div>
                                <span>Personal presente</span>
                            </div>
                            <div class="admin-stat-card">
                                <h4>Personal Extra</h4>
                                <div class="admin-stat-value" id="admin-extra-count">0</div>
                                <span>Conteo de personal extra</span>
                            </div>
                            <div class="admin-stat-card">
                                <h4>Horas Extra</h4>
                                <div class="admin-stat-value" id="admin-extra-hours">0</div>
                                <span>Horas totales extra</span>
                            </div>
                            <!-- Removed: Registros Tard√≠os stat card to avoid duplication with admin alerts -->
                            <!-- Removed: Turno Activo and Turnos con registros tard√≠os per user request -->
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                            <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" id="admin-highlight-active-toggle" checked/> Resaltar turno activo</label>
                            <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" id="admin-filter-active-toggle"/> Mostrar solo turno activo</label>
                        </div>
                    </div>
                    <div id="admin-settings" style="margin-top:12px; background: rgba(255,255,255,0.06); padding:10px; border-radius:6px;">
                        <h4>Ajustes de Turnos y Target</h4>
                        <p style="font-size:0.9rem;">Modifique metas por turno y objetivos de personal. Al guardar, estos valores afectar√°n la meta por hora y c√°lculos de proyecci√≥n. <strong>Nota:</strong> La meta diaria por sistema se mantiene en <em>9000</em> (3 turnos); si desea cambiar la meta diaria, edite la propiedad `metas.diaria` en la configuraci√≥n.</p>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <div style="min-width:220px;">
                                <label>Turno 1 Meta Base</label>
                                <input type="number" id="admin-metaBase-turno-1" value="3000" min="0"/>
                            </div>
                            <div style="min-width:220px;">
                                <label>Turno 2 Meta Base</label>
                                <input type="number" id="admin-metaBase-turno-2" value="3000" min="0"/>
                            </div>
                            <div style="min-width:220px;">
                                <label>Turno 3 Meta Base</label>
                                <input type="number" id="admin-metaBase-turno-3" value="3000" min="0"/>
                            </div>
                            <div style="min-width:220px;">
                                <label>Turno Mixto Meta Base</label>
                                <input type="number" id="admin-metaBase-turno-mixto" value="3000" min="0"/>
                            </div>
                        </div>
                        <div style="margin-top:8px">
                            <h5>Target de plantilla</h5>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <div style="min-width:160px;"><label>Montacarguistas</label><input type="number" id="admin-target-normal-montacarguistas" value="6" min="0"/></div>
                                <div style="min-width:160px;"><label>Almacenistas</label><input type="number" id="admin-target-normal-almacenistas" value="8" min="0"/></div>
                                <div style="min-width:160px;"><label>Auditores</label><input type="number" id="admin-target-normal-auditores" value="3" min="0"/></div>
                                <div style="min-width:160px;"><label>Auxiliares</label><input type="number" id="admin-target-normal-auxiliares" value="2" min="0"/></div>
                            </div>
                        </div>
                        <div style="margin-top:6px">
                            <h5>Target Mixto</h5>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <div style="min-width:160px;"><label>Montacarguistas (Mixto)</label><input type="number" id="admin-target-mixto-montacarguistas" value="2" min="0"/></div>
                                <div style="min-width:160px;"><label>Almacenistas (Mixto)</label><input type="number" id="admin-target-mixto-almacenistas" value="9" min="0"/></div>
                                <div style="min-width:160px;"><label>Auditores (Mixto)</label><input type="number" id="admin-target-mixto-auditores" value="5" min="0"/></div>
                                <div style="min-width:160px;"><label>Auxiliares (Mixto)</label><input type="number" id="admin-target-mixto-auxiliares" value="3" min="0"/></div>
                                <div style="min-width:160px;"><label>Analistas (Mixto)</label><input type="number" id="admin-target-mixto-analistas" value="2" min="0"/></div>
                            </div>
                        </div>
                        
                        <!-- Manage Users (Admin only) -->
                        <div id="admin-user-management" style="margin-top:10px; background: rgba(255,255,255,0.03); padding:10px; border-radius:6px;">
                            <h4>Gesti√≥n de Usuarios</h4>
                            <p>Como administrador puedes crear, editar o eliminar cuentas de usuario en la colecci√≥n <code>users</code>. <strong>Nota:</strong> Esto solo gestiona documentos en Firestore; para crear cuentas de Auth y asignar custom claims, usa Cloud Functions (ejemplo abajo).</p>
                            <form id="admin-create-user-form" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                <input type="text" id="admin-new-user-id" placeholder="ID (ej: 23721 o A001)" style="min-width:160px;" required />
                                <input type="email" id="admin-new-user-email" placeholder="Email (opcional)" style="min-width:220px;" />
                                <select id="admin-new-user-role" style="min-width:160px;">
                                    <option value="coordinator">Coordinador</option>
                                    <option value="admin">Administrador</option>
                                </select>
                                <select id="admin-new-user-cuadrilla" style="min-width:160px;">
                                    <option value="">(Sin asignar)</option>
                                    <option value="cuadrilla-a">Cuadrilla A</option>
                                    <option value="cuadrilla-b">Cuadrilla B</option>
                                    <option value="cuadrilla-c">Cuadrilla C</option>
                                    <option value="mixto">Mixto</option>
                                </select>
                                <button class="export-btn" type="button" id="admin-create-user-btn">‚ûï Crear usuario</button>
                            </form>
                            <div style="margin-top:6px; display:flex; gap:6px; align-items:center;">
                                <input id="admin-cloud-function-url" placeholder="Cloud Function (opcional) - URL" style="min-width:420px;" />
                                <button class="export-btn" id="admin-save-cloudfunc">Guardar</button>
                            </div>
                            <div style="margin-top:8px;">
                                <h5>Usuarios existentes</h5>
                                <div id="admin-users-list">Cargando usuarios...</div>
                            </div>
                            <div style="margin-top:8px; font-size:0.85rem; color:#666;">Opciones adicionales: puedes sincronizar con Auth mediante Cloud Functions para crear la cuenta en Firebase Auth y asignar custom claims.</div>
                        </div>
                        <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">
                            <button class="export-btn" id="admin-save-config">üíæ Guardar cambios</button>
                            <button class="export-btn" id="admin-reset-config">‚ôªÔ∏è Restablecer valores por defecto</button>
                        </div>
                    </div>
                    <!-- Resumen lineal por Turno (Admin) -->
                    <div id="admin-linear-summary" style="margin-top:15px;">
                        <table class="data-table linear-summary-table">
                            <thead>
                                <tr>
                                    <th>Turno</th>
                                    <th>Cajas (actual)</th>
                                    <th>Meta Ajustada</th>
                                    <th>% Cumplimiento</th>
                                    <th>Estado</th>
                                    <th>Progreso</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="admin-row-turno1">
                                    <td>Turno 1 (06:00 - 13:00)</td>
                                    <td id="admin-turno1-progress">0</td>
                                    <td id="admin-turno1-meta-value">-</td>
                                    <td id="admin-turno1-percent">-</td>
                                    <td id="admin-turno1-meta-status"></td>
                                    <td><div class="progress-mini"><div class="progress-mini-fill" id="admin-progress-fill-turno1" style="width:0%"></div></div></td>
                                </tr>
                                <tr id="admin-row-turno2">
                                    <td>Turno 2 (14:00 - 21:00)</td>
                                    <td id="admin-turno2-progress">0</td>
                                    <td id="admin-turno2-meta-value">-</td>
                                    <td id="admin-turno2-percent">-</td>
                                    <td id="admin-turno2-meta-status"></td>
                                    <td><div class="progress-mini"><div class="progress-mini-fill" id="admin-progress-fill-turno2" style="width:0%"></div></div></td>
                                </tr>
                                <tr id="admin-row-turno3">
                                    <td>Turno 3 (22:00 - 05:00)</td>
                                    <td id="admin-turno3-progress">0</td>
                                    <td id="admin-turno3-meta-value">-</td>
                                    <td id="admin-turno3-percent">-</td>
                                    <td id="admin-turno3-meta-status"></td>
                                    <td><div class="progress-mini"><div class="progress-mini-fill" id="admin-progress-fill-turno3" style="width:0%"></div></div></td>
                                </tr>
                                <tr id="admin-row-turno-mixto">
                                    <td>Turno Mixto (08:00 - 18:00)</td>
                                    <td id="admin-turno-mixto-progress">0</td>
                                    <td id="admin-turno-mixto-meta-value">-</td>
                                    <td id="admin-turno-mixto-percent">-</td>
                                    <td id="admin-turno-mixto-meta-status"></td>
                                    <td><div class="progress-mini"><div class="progress-mini-fill" id="admin-progress-fill-turno-mixto" style="width:0%"></div></div></td>
                                </tr>
                                <tr id="admin-row-total">
                                    <td><strong>Total D√≠a</strong></td>
                                    <td id="admin-total-dia-progress">0</td>
                                    <td id="admin-total-estimated-meta">0</td>
                                    <td id="admin-total-percent">-</td>
                                    <td id="admin-total-predicted-meta-status"></td>
                                    <td><div class="progress-mini"><div class="progress-mini-fill" id="admin-progress-fill-total" style="width:0%"></div></div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Informaci√≥n de Cuadrillas por Turno -->
                    <!-- Removed: Distribution of cuadrillas by turno - replaced by admin missing profile alerts -->
                    
                    <div class="dashboard">
                        <div class="chart-container">
                            <div class="chart-title">Progreso por Turno</div>
                            <canvas id="admin-turn-progress-chart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">Eficiencia por Turno</div>
                            <canvas id="admin-turn-efficiency-chart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">Eficiencia por Hora</div>
                            <canvas id="admin-efficiency-chart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">Asistencia por Turno</div>
                            <canvas id="attendance-chart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">Cumplimiento de Metas</div>
                            <canvas id="goals-chart"></canvas>
                        </div>
                    </div>

                    <!-- Section: Hourly entries (Admin only) -->
                    <div id="admin-hourly-entries" style="margin-top: 15px; background-color: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h3>Registros Horarios (Todos los Turnos)</h3>
                        <div id="admin-hourly-table">No hay registros</div>
                    </div>
                    <div id="admin-extras-entries" style="margin-top: 15px; background-color: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h3>Personal Extra (Detalles)</h3>
                        <div id="admin-extras-table">No hay personal extra registrado</div>
                    </div>

                    <!-- Detalle por Cuadrilla (Admin) -->
                    <div id="admin-cuadrilla-details-section" style="margin-top: 15px; background-color: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h3>Detalle por Cuadrilla</h3>
                        <div id="admin-cuadrilla-details">No hay datos</div>
                    </div>

                    <!-- Secci√≥n de Exportaci√≥n -->
                    <div class="export-section">
                        <h3>Exportaci√≥n de Datos</h3>
                        <p>Exporte los datos registrados para su an√°lisis en Excel</p>
                        
                        <div class="data-preview">
                            <h4>Vista Previa de Datos del D√≠a</h4>
                            <div id="data-preview-content">
                                <p>Seleccione una fecha para ver los datos</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="export-date">Seleccionar Fecha:</label>
                            <input type="date" id="export-date" value="">
                        </div>
                        <div class="form-group">
                            <label for="admin-live-toggle">Vista en tiempo real (Admin)</label>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <input type="checkbox" id="admin-live-toggle">
                                <small>Si est√° activado, el dashboard mostrar√° datos en vivo y se actualizar√° autom√°ticamente.</small>
                            </div>
                        </div>
                        
                        <div class="export-buttons">
                            <button class="export-btn excel" id="export-daily-excel">
                                üìä Exportar Datos del D√≠a Completo
                            </button>
                            <button class="export-btn" id="export-backup">
                                üìÅ Exportar Reporte Completo (Excel)
                            </button>
                            <label style="display:inline-flex; align-items:center; gap:8px; margin-left:10px; font-size:0.9rem;">
                                <input type="checkbox" id="append-aggregated-export"> Agregar a exportaci√≥n acumulada
                            </label>
                            <button class="export-btn" id="export-aggregated-excel">
                                üì• Exportar Acumulado
                            </button>
                            <button class="export-btn" id="clear-aggregated-export" title="Limpiar archivo de exportaci√≥n acumulada">
                                üóëÔ∏è Limpiar Acumulado
                            </button>
                            <!-- Demo button removed per request -->
                            <button class="export-btn" id="clear-local-data">
                                üßπ Limpiar Datos Locales
                            </button>
                        </div>
                        
                        <div class="last-export" id="last-export-info">
                            √öltima exportaci√≥n: Nunca
                        </div>
                    </div>
                </div>
                <!-- Informaci√≥n Mixto para Administrador -->
                <div id="mixto-info-admin" class="mixto-info" style="display: none; margin-top: 15px;">
                    <h3>üìä Turno Mixto - Vista Administrador</h3>
                    <div class="mixto-stats">
                        <div class="mixto-stat">
                            <div>Turno 1</div>
                            <div class="summary-value" style="color: var(--turno1-color)" id="mixto-admin-turno1">0</div>
                        </div>
                        <div class="mixto-stat">
                            <div>Turno 2</div>
                            <div class="summary-value" style="color: var(--turno2-color)" id="mixto-admin-turno2">0</div>
                        </div>
                        <div class="mixto-stat">
                            <div>Turno 3</div>
                            <div class="summary-value" style="color: var(--turno3-color)" id="mixto-admin-turno3">0</div>
                        </div>
                        <div class="mixto-stat">
                            <div>Total D√≠a</div>
                            <div class="summary-value" style="color: white" id="mixto-admin-total">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let userType = null;
        let currentTurno = null;
        let isMixto = false;
        let currentCuadrilla = null;
        let currentShiftData = null;
        let adminLiveInterval = null;
        let extraStaffEntries = [];
        // Theme colors read from CSS variables (keeps JS visuals in sync with CSS palette)
        const THEME = (function(){
            const s = getComputedStyle(document.documentElement);
            return {
                primary: s.getPropertyValue('--primary-color').trim(),
                primaryDark: s.getPropertyValue('--primary-dark').trim(),
                secondary: s.getPropertyValue('--secondary-color').trim(),
                success: s.getPropertyValue('--success-color').trim(),
                danger: s.getPropertyValue('--danger-color').trim(),
                cuadrillaA: s.getPropertyValue('--cuadrilla-a-color').trim(),
                cuadrillaB: s.getPropertyValue('--cuadrilla-b-color').trim(),
                cuadrillaC: s.getPropertyValue('--cuadrilla-c-color').trim(),
                turno1: s.getPropertyValue('--turno1-color').trim(),
                turno2: s.getPropertyValue('--turno2-color').trim(),
                turno3: s.getPropertyValue('--turno3-color').trim(),
                mixto: s.getPropertyValue('--turno-mixto-color').trim(),
            }
        })();
        function getTurnoColor(turno){
            if(!turno) return THEME.turno1;
            if(turno === 'mixto') return THEME.mixto;
            if(turno === '1') return THEME.turno1;
            if(turno === '2') return THEME.turno2;
            if(turno === '3') return THEME.turno3;
            return THEME.turno1;
        }
        
        // Configuraci√≥n del sistema
        const SYSTEM_CONFIG = {
            coordinadores: {
                'cuadrilla-a': ['23721'],
                'cuadrilla-b': ['19091'], 
                'cuadrilla-c': ['26536'],
                'mixto': ['26992']
            },
            administradores: ['A001'],
            turnos: {
                '1': { 
                    inicio: 6, 
                    fin: 13, 
                    horas: [6,7,8,9,10,11,12,13],
                    lunch: { hour: 10, minute: 30 },
                    color: '#CF002E', 
                    nombre: 'Turno 1 (06:00 - 13:00)',
                    metaBase: 3000
                },
                '2': { 
                    inicio: 14, 
                    fin: 21, 
                    horas: [14,15,16,17,18,19,20,21],
                    lunch: { hour: 18, minute: 0 },
                    color: '#FDD000', 
                    nombre: 'Turno 2 (14:00 - 21:00)',
                    metaBase: 3000
                },
                '3': { 
                    inicio: 22, 
                    fin: 5, 
                    horas: [22,23,0,1,2,3,4,5],
                    lunch: { hour: 2, minute: 0 },
                    color: '#CF002E', 
                    nombre: 'Turno 3 (22:00 - 05:00)',
                    metaBase: 3000
                },
                'mixto': { 
                    inicio: 8, 
                    fin: 18, 
                    horas: [8,9,10,11,12,13,14,15,16,17,18],
                    lunch: { hour: 12, minute: 30 },
                    color: '#FDD000', 
                    nombre: 'Turno Mixto (08:00 - 18:00)',
                    metaBase: 3000
                }
            },
            cuadrillas: {
                'cuadrilla-a': { color: '#3498db', nombre: 'Cuadrilla A' },
                'cuadrilla-b': { color: '#2ecc71', nombre: 'Cuadrilla B' },
                'cuadrilla-c': { color: '#9b59b6', nombre: 'Cuadrilla C' }
            },
            personal: {
                normal: {
                    montacarguistas: 6,
                    almacenistas: 8,
                    auditores: 3,
                    auxiliares: 2,
                    analistas: 0
                },
                mixto: {
                    montacarguistas: 2,
                    almacenistas: 9,
                    auditores: 5,
                    auxiliares: 3,
                    analistas: 2
                }
            },
            metas: {
                diaria: 9000,
                porHora: 400
            },
            limites: {
                inicioTurno: 60, // minutos
                registroHorario: 59 // minutos
            }
        };
        const DEFAULT_SYSTEM_CONFIG = JSON.parse(JSON.stringify(SYSTEM_CONFIG));
        // Rotaci√≥n: base y fecha de inicio para ciclos de 15 d√≠as
        // Base order: en el ciclo actual (hasta 2025-12-07) se asigna:
        // Turno1 -> 'cuadrilla-b' (19091), Turno2 -> 'cuadrilla-a' (23721), Turno3 -> 'cuadrilla-c' (26536)
        // El ciclo cambia cada 15 d√≠as y el primer cambio solicitado por el usuario es 2025-12-08
        SYSTEM_CONFIG.rotation = {
            baseOrder: ['cuadrilla-b', 'cuadrilla-a', 'cuadrilla-c'],
            epochDate: '2025-11-23', // ciclo 0 empieza 2025-11-23 y cambia 2025-12-08
            cycleDays: 15
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar selector de tipo de usuario
            setupUserTypeSelector();
            
            // Configurar login
            setupLogin();
            
            // Configurar logout
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Actualizar hora actual
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Configurar fecha de exportaci√≥n
            document.getElementById('export-date').value = new Date().toISOString().split('T')[0];
            
            // Inicializar Firebase (si el usuario agreg√≥ la configuraci√≥n)
            try { initFirebase(); } catch (e) { console.warn('initFirebase not available', e); }

            // Verificar si ya hay una sesi√≥n activa
            checkExistingSession();
            // Pre-fill login form with saved user to speed up hourly re-logins
            try {
                const savedUser = sessionStorage.getItem('currentUser');
                const savedType = sessionStorage.getItem('userType');
                if (savedUser) document.getElementById('user-id').value = savedUser;
                if (savedType) {
                    const el = document.querySelector(`.user-type[data-type="${savedType}"]`);
                    if (el) { document.querySelectorAll('.user-type').forEach(t => t.classList.remove('active')); el.classList.add('active'); }
                }
            } catch (e) { console.warn('prefill login failed', e); }
            // Si Firebase est√° inicializado, atachamos el listener de auth para gestionar sesiones basadas en custom tokens
            try {
                if (window.firebaseInitialized && window.auth) {
                    window.auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            // Leer claims (role) desde el id token
                            try {
                                const idTokenResult = await user.getIdTokenResult(true);
                                const role = idTokenResult.claims.role || idTokenResult.claims['role'] || 'coordinator';
                                // Optional claim 'id' can carry user ID if set by Cloud Function. Fallback to local storage.
                                                const providedId = idTokenResult.claims.id || sessionStorage.getItem('currentUser') || user.uid;
                                // Set state
                                currentUser = providedId;
                                userType = (role === 'admin') ? 'admin' : 'coordinator';
                                // Persist session only in sessionStorage (session-only mode)
                                loginUser(currentUser, userType, false);
                            } catch (e) {
                                console.warn('getIdTokenResult failed', e);
                                // If token retrieval failed, fallback to local login state
                                const savedUser = sessionStorage.getItem('currentUser');
                                const savedType = sessionStorage.getItem('userType');
                                if (savedUser && savedType) loginUser(savedUser, savedType, false);
                            }
                        } else {
                            // Not signed in: if we have a local session, keep it, but if not, ensure UI is logged out
                            const savedUser = sessionStorage.getItem('currentUser');
                            const savedType = sessionStorage.getItem('userType');
                            if (!savedUser || !savedType) logout();
                        }
                    });
                }
            } catch (e) { console.warn('auth state listener setup failed', e); }
            // Aplicar overrides de configuraci√≥n si existen y preparar UI admin
            const adminOverrides = JSON.parse(localStorage.getItem('adminConfigOverrides') || '{}');
            if (Object.keys(adminOverrides).length) applyAdminOverridesToSystem(adminOverrides);
            initAdminConfigUI();
            updateHCTargetDisplays();
            // Si recuperamos conectividad, intentamos sincronizar datos locales pendientes con Firestore
            window.addEventListener('online', function() { if (window.firebaseInitialized) syncLocalToFirestore(); });
        });
        
        function setupUserTypeSelector() {
            const userTypes = document.querySelectorAll('.user-type');
            
            userTypes.forEach(type => {
                type.addEventListener('click', function() {
                    userTypes.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        function setupLogin() {
            document.getElementById('login-btn').addEventListener('click', async function() {
                const userId = document.getElementById('user-id').value.trim();
                const password = document.getElementById('password').value;
                const selectedType = document.querySelector('.user-type.active').getAttribute('data-type');
                
                if (!userId) {
                    alert('Por favor ingrese su ID de usuario');
                    return;
                }
                
                // Primero intentamos autenticar v√≠a Cloud Function (m√°s segura): devuelve un custom token
                let token = null;
                try {
                    token = await signInWithIdAndGetCustomToken(userId, password);
                } catch (e) {
                    // Funci√≥n no existe / error -> fallback a validaciones remotas/locales
                    console.warn('signInWithId CF failed, fallback to local/remote validation', e);
                }

                // Validar credenciales localmente si no conseguimos token
                const okLocal = token ? true : validateCredentials(userId, password, selectedType);
                let okRemote = false;
                // Si existe conexi√≥n a Firebase, intentar validaci√≥n remota para mayor seguridad
                try {
                    if (window.firebaseInitialized && window.db) {
                        okRemote = await validateCredentialsRemote(userId, selectedType);
                    }
                } catch (e) {
                    console.warn('remote validation attempt failed', e);
                }

                if (okLocal || okRemote) {
                    // si hay validaci√≥n remota y es admin, sincronizar y (si aplica) habilitar listeners en vivo
                    try { initFirebase(); } catch (e) { /* already init */ }
                    // sincronizar datos locales pendientes
                    try { await syncLocalToFirestore(); } catch (e) { console.warn('syncLocal failed', e); }
                    // Si obtuvimos un token (Cloud Function) usamos Auth para iniciar sesi√≥n y guardar claims
                    if (token) {
                        try {
                            // Persist session in session storage only (no localStorage). This avoids persistent logins.
                            const persistence = firebase.auth.Auth.Persistence.SESSION;
                            await firebase.auth().setPersistence(persistence);
                            await firebase.auth().signInWithCustomToken(token);
                            // Firebase auth onAuthStateChanged manejar√° el UI y claims
                        } catch (e) {
                            console.warn('signInWithCustomToken failed, fallback to local login', e);
                            // Always use session-only persistence (user selected Option C)
                            loginUser(userId, selectedType, false);
                        }
                    } else {
                        // Always use session-only persistence (user selected Option C)
                        loginUser(userId, selectedType, false);
                    }
                } else {
                    alert('Credenciales incorrectas. Por favor verifique.');
                }
            });
        }

        // Intenta llamar a la Cloud Function que valida ID/Password y devuelve un custom token
        async function signInWithIdAndGetCustomToken(userId, password) {
            if (!window.firebaseInitialized || !window.functions) throw new Error('No Firebase functions available');
            try {
                const callable = window.functions.httpsCallable('signInWithId');
                const result = await callable({ id: userId, password: password });
                if (result && result.data && result.data.token) return result.data.token;
                throw new Error('signInWithId returned no token');
            } catch (e) {
                // Provide a clearer error if the function doesn't exist or permission denied
                if (e && e.code === 'functions/not-found') {
                    throw new Error('Cloud Function not found');
                }
                throw e;
            }
        }
        
        function validateCredentials(userId, password, type) {
            if (type === 'coordinator') {
                // Verificar en todos los turnos
                for (let cuadrilla in SYSTEM_CONFIG.coordinadores) {
                    if (SYSTEM_CONFIG.coordinadores[cuadrilla].includes(userId)) {
                        return true;
                    }
                }
                return false;
            }
            
            if (type === 'admin') {
                return SYSTEM_CONFIG.administradores.includes(userId);
            }
            
            return false;
        }
        
        function loginUser(userId, type, remember = false) {
            currentUser = userId;
            userType = type;
            
            // Determinar cuadrilla actual y si es mixto
            determineUserCuadrilla(userId);
            
            // Determinar turno actual basado en la rotaci√≥n de SYSTEM_CONFIG.rotation (ciclos de 15 d√≠as)
            determineCurrentTurno();
            
            // Guardar sesi√≥n en sessionStorage (no persistente)
            try {
                sessionStorage.setItem('currentUser', userId);
                sessionStorage.setItem('userType', type);
                // Clean localStorage just in case old persisted values exist
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userType');
            } catch (e) { console.warn('Failed writing session to sessionStorage', e); }
            
            // Actualizar interfaz
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-system').style.display = 'block';
            
            // Actualizar informaci√≥n de usuario
            document.getElementById('user-id-display').textContent = `ID: ${userId}`;
            
            if (type === 'admin') {
                setupAdminInterface();
            } else {
                setupCoordinatorInterface();
            }
        }
        
        function determineUserCuadrilla(userId) {
            // Determinar a qu√© cuadrilla pertenece el usuario
            if (SYSTEM_CONFIG.coordinadores.mixto.includes(userId)) {
                currentCuadrilla = 'mixto';
                isMixto = true;
            } else if (SYSTEM_CONFIG.coordinadores['cuadrilla-a'].includes(userId)) {
                currentCuadrilla = 'cuadrilla-a';
                isMixto = false;
            } else if (SYSTEM_CONFIG.coordinadores['cuadrilla-b'].includes(userId)) {
                currentCuadrilla = 'cuadrilla-b';
                isMixto = false;
            } else if (SYSTEM_CONFIG.coordinadores['cuadrilla-c'].includes(userId)) {
                currentCuadrilla = 'cuadrilla-c';
                isMixto = false;
            }
        }
        
        function determineCurrentTurno() {
            // Para el turno mixto, siempre es 'mixto'
            if (currentCuadrilla === 'mixto') {
                currentTurno = 'mixto';
                return;
            }
            
            // Rotaci√≥n por ciclos definidos en SYSTEM_CONFIG.rotation
            // Se usa epochDate y cycleDays (15) como base, y baseOrder como el orden de cuadrillas en ciclo 0
            const now = new Date();
            currentTurno = getCurrentTurnoForCuadrilla(currentCuadrilla, now);
            
            // Guardar informaci√≥n de rotaci√≥n (guardamos la fecha actual como referencia)
            localStorage.setItem('currentTurno', currentTurno);
        }

        function getRotationIndexForDate(date) {
            try {
                const epoch = new Date(SYSTEM_CONFIG.rotation.epochDate);
                const msPerDay = 24 * 60 * 60 * 1000;
                const days = Math.floor((date - epoch) / msPerDay);
                const cycleIdx = Math.floor(days / SYSTEM_CONFIG.rotation.cycleDays);
                return ((cycleIdx % 3) + 3) % 3; // ensure positive mod
            } catch (e) {
                return 0;
            }
        }
        
        function setupAdminInterface() {
            document.getElementById('user-badge').textContent = 'Administrador';
            document.getElementById('user-badge').classList.add('admin');
            document.getElementById('admin-tabs').style.display = 'flex';
            document.getElementById('admin-content').style.display = 'block';
            document.getElementById('coordinator-content').style.display = 'none';
            document.getElementById('coordinator-tabs').style.display = 'none';
            // removed: distribuci√≥n de cuadrillas por turno
            setupAdminSystem();
        }
        
        function setupCoordinatorInterface() {
            let turnoText = '';
            if (isMixto) {
                turnoText = 'Coordinador Mixto';
                document.getElementById('user-badge').classList.add('mixto');
                document.getElementById('mixto-info').style.display = 'block';
                document.getElementById('cuadrilla-info').style.display = 'none';
                document.getElementById('analistas-card').style.display = 'block';
                
                // Do not update the HC target display from saved attendance; leave targets visible from SYSTEM_CONFIG or admin overrides.
            } else {
                const cuadrillaName = SYSTEM_CONFIG.cuadrillas[currentCuadrilla].nombre;
                turnoText = `${cuadrillaName} - Turno ${currentTurno}`;
                document.getElementById('user-badge').classList.add(currentCuadrilla);
                document.getElementById('mixto-info').style.display = 'none';
                document.getElementById('cuadrilla-info').style.display = 'block';
                document.getElementById('analistas-card').style.display = 'none';
                
                // Actualizar informaci√≥n de cuadrilla
                document.getElementById('cuadrilla-name').textContent = cuadrillaName.charAt(cuadrillaName.length - 1);
                document.getElementById('cuadrilla-turno').textContent = currentTurno;
                document.getElementById('cuadrilla-horario').textContent = SYSTEM_CONFIG.turnos[currentTurno].nombre.match(/\(([^)]+)\)/)[1];
                document.getElementById('cuadrilla-description').textContent = 
                    `${cuadrillaName} - ${SYSTEM_CONFIG.turnos[currentTurno].nombre}`;
                
                // Do not update the HC target display from saved attendance; leave targets visible from SYSTEM_CONFIG or admin overrides.
            }
            
            document.getElementById('user-badge').textContent = turnoText;
            document.getElementById('user-badge').classList.remove('admin');
            document.getElementById('coordinator-tabs').style.display = 'flex';
            document.getElementById('coordinator-content').style.display = 'block';
            document.getElementById('admin-content').style.display = 'none';
            document.getElementById('admin-tabs').style.display = 'none';
            setupCoordinatorSystem();
            // Ensure HC Target displays reflect the system configuration (not presentes)
            updateHCTargetDisplays();
            // Ensure admin alerts are hidden when a coordinator logs in or switches view
            const alertsContainer = document.getElementById('admin-alerts');
            if (alertsContainer) {
                alertsContainer.style.display = 'none';
                alertsContainer.innerHTML = '';
            }
        }
        
        function setupCoordinatorSystem() {
            // Configurar color del progress bar seg√∫n el turno
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.backgroundColor = SYSTEM_CONFIG.turnos[currentTurno].color;
            
            // Configurar formularios
            setupStartShiftForm();
            setupHourlyForm();
            
            // Configurar vista de progreso
            initializeProgressCharts();
            updateProgressView();
            
            // Verificar l√≠mites de tiempo para todos los coordinadores
            checkTimeLimits();
            setInterval(checkTimeLimits, 60000);
            
            // Configurar navegaci√≥n
            setupTabs();
            // Configurar admin highlight/filter toggles
            setupAdminActiveControls();
        }
        
        function setupAdminSystem() {
            // Configurar dashboard
            initializeAdminCharts();
            updateAdminDashboard();
            
            // Configurar exportaci√≥n
            setupExportButtons();
            // Gestion de usuarios
            setupUserManagementUI();
            setupAdminLiveToggle();
            updateLastExportInfo();
            
            // Verificar alertas
            checkAdminAlerts();
            setInterval(checkAdminAlerts, 300000);
            
            // Configurar navegaci√≥n
            setupTabs();
            // Configurar admin highlight/filter toggles
            setupAdminActiveControls();
            // Setup user management UI after admin interface is visible
            function setupUserManagementUI() {
                const btn = document.getElementById('admin-create-user-btn');
                const form = document.getElementById('admin-create-user-form');
                const listEl = document.getElementById('admin-users-list');

                async function loadUsers() {
                    if (!window.db) {
                        listEl.innerHTML = '<div>Firestore no disponible - modo offline o permisos insuficientes.</div>';
                        return;
                    }
                    try {
                        listEl.innerHTML = 'Cargando...';
                        const snapshot = await window.db.collection('users').get();
                        if (!snapshot.empty) {
                            const rows = [];
                            rows.push('<table class="data-table"><thead><tr><th>ID</th><th>Email</th><th>Rol</th><th>Cuadrilla</th><th>Acciones</th></tr></thead><tbody>');
                            snapshot.forEach(doc => {
                                const d = doc.data() || {};
                                    rows.push(`<tr><td>${doc.id}</td><td>${d.email||'-'}</td><td>${d.role||'-'}</td><td>${d.cuadrilla||'-'}</td><td><button class="remove-user" data-id="${doc.id}">Eliminar</button> <button class="create-auth" data-id="${doc.id}" data-email="${d.email||''}">Crear Auth</button></td></tr>`);
                            });
                            rows.push('</tbody></table>');
                            listEl.innerHTML = rows.join('');
                            // attach delete and createAuth handlers
                            Array.from(listEl.querySelectorAll('.remove-user')).forEach(b => {
                                b.addEventListener('click', async function() {
                                    const uid = this.getAttribute('data-id');
                                    if (!confirm(`Eliminar usuario ${uid}?`)) return;
                                    try {
                                        await window.db.collection('users').doc(uid).delete();
                                        await loadUsers();
                                        alert('Usuario eliminado');
                                    } catch (e) {
                                        console.warn('Error deleting user', e);
                                        alert('No se pudo eliminar usuario: verificar permisos o conectividad');
                                    }
                                });
                            });
                            Array.from(listEl.querySelectorAll('.create-auth')).forEach(b => {
                                b.addEventListener('click', async function() {
                                    const uid = this.getAttribute('data-id');
                                    const email = this.getAttribute('data-email');
                                    const cfUrl = document.getElementById('admin-cloud-function-url').value.trim() || localStorage.getItem('adminCloudFunctionUrl');
                                    if (!cfUrl) { alert('No Cloud Function URL configured. Guardar la URL en el campo arriba.'); return; }
                                    if (!confirm(`Crear cuenta de Auth para ${uid} (${email || 'sin email'})?`)) return;
                                    try {
                                        const body = { uid, email };
                                        // If URL looks like an HTTP endpoint, use fetch
                                        if (cfUrl.startsWith('http://') || cfUrl.startsWith('https://')) {
                                            const res = await fetch(cfUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                                            if (!res.ok) throw new Error('HTTP error ' + res.status);
                                            const json = await res.json();
                                            alert('Cloud Function responded: ' + (json.message || JSON.stringify(json)));
                                        } else {
                                            // treat cfUrl as callable function name (e.g., 'createAuthUser')
                                            if (!window.functions) throw new Error('Funciones de Firebase no inicializadas en el cliente');
                                            const callFunc = window.functions.httpsCallable(cfUrl);
                                            const result = await callFunc(body);
                                            alert('Callable function responded: ' + JSON.stringify(result && result.data || {}));
                                        }
                                    } catch (e) {
                                        console.warn('Error calling cloud function', e);
                                        alert('Error creando Auth user: revisa la Cloud Function y los logs');
                                    }
                                });
                            });
                        } else {
                            listEl.innerHTML = 'No hay usuarios';
                        }
                    } catch (e) {
                        console.warn('Error loading users', e);
                        listEl.innerHTML = '<div>Error cargando usuarios - ver consola.</div>';
                    }
                }

                if (btn) {
                    btn.addEventListener('click', async function() {
                        const uid = document.getElementById('admin-new-user-id').value.trim();
                        const email = document.getElementById('admin-new-user-email').value.trim();
                        const role = document.getElementById('admin-new-user-role').value;
                        const cuadrilla = document.getElementById('admin-new-user-cuadrilla').value || '';
                        if (!uid || !role) { alert('ID y rol son obligatorios'); return; }
                        if (!window.db) { alert('Firestore no disponible.'); return; }
                        try {
                            await window.db.collection('users').doc(uid).set({ role, cuadrilla, email, createdAt: new Date().toISOString() });
                            alert('Usuario creado/actualizado en Firestore');
                            // clear form
                            document.getElementById('admin-new-user-id').value = '';
                            document.getElementById('admin-new-user-email').value = '';
                            document.getElementById('admin-new-user-role').value = 'coordinator';
                            document.getElementById('admin-new-user-cuadrilla').value = '';
                            await loadUsers();
                            // Optionally call cloud function / API to create Auth user & set claims
                        } catch (e) {
                            console.warn('Error creating user', e);
                            alert('No se pudo crear usuario ‚Äî verificar permisos en Firestore y conectividad');
                        }
                    });
                }

                // Load cloud function URL from storage (if any)
                try {
                    const storedCf = localStorage.getItem('adminCloudFunctionUrl');
                    if (storedCf) document.getElementById('admin-cloud-function-url').value = storedCf;
                } catch(e){}

                // Save cloud function URL button
                const cfSaveBtn = document.getElementById('admin-save-cloudfunc');
                if (cfSaveBtn) {
                    cfSaveBtn.addEventListener('click', function() {
                        const url = document.getElementById('admin-cloud-function-url').value.trim();
                        if (!url) { alert('Ingrese una URL'); return; }
                        localStorage.setItem('adminCloudFunctionUrl', url);
                        alert('Cloud Function URL guardada en storage local');
                    });
                }

                // Load users on open
                loadUsers();
            }
            // important: attach user management setup to variable so we can call it from the scope
            try { setupUserManagementUI(); } catch (e) { console.warn('setupUserManagementUI failed', e); }
        }
        
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover clase activa de todas las pesta√±as
                    tabs.forEach(t => t.classList.remove('active'));
                    // Agregar clase activa a la pesta√±a clickeada
                    this.classList.add('active');
                    
                    // Ocultar todo el contenido
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Mostrar el contenido correspondiente
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Actualizar contenido seg√∫n la pesta√±a
                    if (tabId === 'progress-view' && userType === 'coordinator') {
                        updateProgressView();
                    } else if (tabId === 'dashboard' && userType === 'admin') {
                        updateAdminDashboard();
                    }
                });
            });
        }
        
        function setupStartShiftForm() {
            const form = document.getElementById('start-shift-form');
            
            // Rellenar autom√°ticamente el ID del coordinador
            document.getElementById('coordinator-id').value = currentUser;
            
            // Actualizar meta del turno
            updateTurnoMeta();
            
            // Enviar formulario
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const now = new Date();
                const day = now.getDay(); // 0=Sunday
                if (day === 0) {
                    alert('Domingo: no se permite iniciar turnos ni registrar horas.');
                    return;
                }

                if (!canSubmitStartShift()) {
                    alert('El tiempo para registrar el inicio de turno ha expirado');
                    return;
                }
                
                const shiftData = {
                    coordinatorId: currentUser,
                    cuadrilla: currentCuadrilla,
                    turno: currentTurno,
                    isMixto: isMixto,
                    timestamp: new Date().toISOString(),
                    attendance: {
                        montas: parseInt(document.getElementById('montas-presentes').value),
                        alm: parseInt(document.getElementById('alm-presentes').value),
                        auditores: parseInt(document.getElementById('auditores-presentes').value),
                        auxiliares: parseInt(document.getElementById('auxiliares-presentes').value),
                        analistas: isMixto ? parseInt(document.getElementById('analistas-presentes').value) : 0
                    },
                    comentarios: document.getElementById('comentarios-asistencia').value,
                    metaTurno: calculateTurnoMeta(),
                    extras: extraStaffEntries
                };
                
                // Guardar datos
                saveShiftData(shiftData);
                currentShiftData = shiftData;
                // Do not override visible HC Target with saved attendance here; keep targets driven by system config or admin overrides.
                alert('Inicio de turno registrado correctamente');
                form.reset();
                extraStaffEntries = [];
                renderExtraList();
                
                // Actualizar vista de progreso
                updateProgressView();
            });
            
            // Actualizar meta cuando cambia la asistencia
            ['montas-presentes', 'alm-presentes', 'auditores-presentes', 'auxiliares-presentes', 'analistas-presentes'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateTurnoMeta);
            });

            // Inicializar formulario de personal extra
            initializeExtraStaffForm();
            // Cargar extras si ya est√°n guardados para hoy
            loadExtraEntriesFromSavedShift();
        }
        
        function updateTurnoMeta() {
            const metaAjustada = calculateTurnoMeta();
            document.getElementById('meta-turno-ajustada').textContent = metaAjustada;
            document.getElementById('meta-turno-display').textContent = metaAjustada;
            
            // Calcular meta por hora (excluyendo horas con descanso)
            const turnoConfig = SYSTEM_CONFIG.turnos[currentTurno];
            const turnoHoras = turnoConfig.horas || [];
            const lunchHour = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.hour : null;
            const lunchMinute = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.minute : 0;
            // Only block the exact configured lunch hour for Turnos 1/2/3; do not block Mixto or adjacent hour.
            const blockedLunchHours = (lunchHour !== null && currentTurno !== 'mixto') ? [lunchHour] : [];
            // Use fixed 7 direct hours when computing meta per hour
            const horasTurno = 7;
            const metaHora = Math.round(metaAjustada / horasTurno);
            document.getElementById('meta-hora-display').textContent = metaHora;
            // Do not override displayed HC Target with 'presentes' values here ‚Äî keep HC Target sourced from SYSTEM_CONFIG or saved shift.
        }
        
        function calculateTurnoMeta() {
            if (isMixto) {
                const montas = parseInt(document.getElementById('montas-presentes').value) || 0;
                const alm = parseInt(document.getElementById('alm-presentes').value) || 0;
                const auditores = parseInt(document.getElementById('auditores-presentes').value) || 0;
                const auxiliares = parseInt(document.getElementById('auxiliares-presentes').value) || 0;
                const analistas = parseInt(document.getElementById('analistas-presentes').value) || 0;
                
                const totalPresente = montas + alm + auditores + auxiliares + analistas;
                const totalObjetivo = SYSTEM_CONFIG.personal.mixto.montacarguistas + 
                                     SYSTEM_CONFIG.personal.mixto.almacenistas + 
                                     SYSTEM_CONFIG.personal.mixto.auditores + 
                                     SYSTEM_CONFIG.personal.mixto.auxiliares +
                                     SYSTEM_CONFIG.personal.mixto.analistas;
                
                // Ajustar meta basado en el porcentaje de personal presente
                const porcentajePresente = totalPresente / totalObjetivo;
                const metaBase = SYSTEM_CONFIG.turnos.mixto.metaBase;
                const metaAjustada = Math.round(metaBase * porcentajePresente);
                
                return Math.max(metaAjustada, 0);
            } else {
                const montas = parseInt(document.getElementById('montas-presentes').value) || 0;
                const alm = parseInt(document.getElementById('alm-presentes').value) || 0;
                const auditores = parseInt(document.getElementById('auditores-presentes').value) || 0;
                const auxiliares = parseInt(document.getElementById('auxiliares-presentes').value) || 0;
                
                const totalPresente = montas + alm + auditores + auxiliares;
                const totalObjetivo = SYSTEM_CONFIG.personal.normal.montacarguistas + 
                                     SYSTEM_CONFIG.personal.normal.almacenistas + 
                                     SYSTEM_CONFIG.personal.normal.auditores + 
                                     SYSTEM_CONFIG.personal.normal.auxiliares;
                
                // Ajustar meta basado en el porcentaje de personal presente
                const porcentajePresente = totalPresente / totalObjetivo;
                const metaBase = SYSTEM_CONFIG.turnos[currentTurno].metaBase;
                const metaAjustada = Math.round(metaBase * porcentajePresente);
                
                return Math.max(metaAjustada, 0);
            }
        }
        
        function setupHourlyForm() {
            const form = document.getElementById('hourly-form');
            const hourSelect = document.getElementById('current-hour');
            
            // Rellenar autom√°ticamente el ID del coordinador
            document.getElementById('hourly-coordinator-id').value = currentUser;
            // Quick Check-in button handler
            const quickCheckin = document.getElementById('quick-checkin');
            if (quickCheckin) {
                quickCheckin.addEventListener('click', async function() {
                    try {
                        // choose the current hour
                        const h = new Date().getHours();
                        if (!canSubmitHourly(h)) { alert('No es posible registrar esta hora (fuera de ventana permitida).'); return; }
                        // compute a simple hourlyData object with minimal required fields
                        const hourlyData = {
                            hour: ('0' + h).slice(-2),
                            cajas: 0,
                            coordinator: currentUser,
                            cuadrilla: currentCuadrilla,
                            timestamp: new Date().toISOString(),
                            isLate: !canSubmitHourly(h)
                        };
                        // use saveHourlyData which handles localStorage and Firestore
                        saveHourlyData(hourlyData);
                        // update UI
                        alert('Check-in r√°pido registrado para la hora ' + hourlyData.hour);
                        updateProgressView();
                        // Sync to firestore in background
                        if (navigator.onLine && window.firebaseInitialized) try { await syncLocalToFirestore(); } catch (e) { console.warn('syncLocalToFirestore in quick-checkin failed', e); }
                    } catch (e) {
                        console.warn('quick checkin failed', e);
                        alert('No se pudo registrar el check-in. Intente nuevamente.');
                    }
                });
            }
            
            // Generar opciones de horas
            generateHourOptions();
            
            // Enviar formulario
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const now = new Date();
                if (now.getDay() === 0) {
                    alert('Domingo: no se permite registrar por horas.');
                    return;
                }
                const hour = document.getElementById('current-hour').value;
                // Block registration if it's the lunch hour for the currentTurno
                const turnoConfig = SYSTEM_CONFIG.turnos[currentTurno] || {};
                const lHour = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.hour : null;
                const lMinute = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.minute : 0;
                const blockedLunchHours = (lHour !== null && currentTurno !== 'mixto') ? [lHour] : [];
                const selectedHourNum = parseInt(hour, 10);
                if (blockedLunchHours.includes(selectedHourNum)) {
                    alert('No se permite registrar datos durante la hora de descanso.');
                    return;
                }
                const cajas = parseInt(document.getElementById('cajas').value);
                const isLate = !canSubmitHourly(hour);
                
                if (isLate && !confirm('Est√° registrando fuera del tiempo l√≠mite. ¬øDesea continuar?')) {
                    return;
                }
                
                const hourlyData = {
                    coordinatorId: currentUser,
                    cuadrilla: currentCuadrilla,
                    turno: currentTurno,
                    isMixto: isMixto,
                    hour: hour,
                    cajas: cajas,
                    timestamp: new Date().toISOString(),
                    isLate: isLate
                };
                
                // Guardar datos
                saveHourlyData(hourlyData);
                alert('Datos registrados correctamente' + (isLate ? ' (registro tard√≠o)' : ''));
                form.reset();
                document.getElementById('late-registration-warning').style.display = 'none';
                
                // Actualizar progreso
                updateProgress();
                updateProgressView();
            });
            
            // Mostrar advertencia de registro tard√≠o y de descanso (si aplica)
            hourSelect.addEventListener('change', function() {
                const hour = this.value;
                // Late warning
                if (hour && !canSubmitHourly(hour)) {
                    document.getElementById('late-registration-warning').style.display = 'block';
                } else {
                    document.getElementById('late-registration-warning').style.display = 'none';
                }
                // Lunch warning (if dataset present)
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.dataset && selectedOption.dataset.lunch === 'true') {
                    document.getElementById('lunch-warning').style.display = 'block';
                } else {
                    document.getElementById('lunch-warning').style.display = 'none';
                }
            });
        }
        
        function generateHourOptions() {
            const hourSelect = document.getElementById('current-hour');
            hourSelect.innerHTML = '<option value="">Seleccione la hora</option>';
            
            // Generar horas seg√∫n el turno actual (anotando descansos)
            const turnoConfig = SYSTEM_CONFIG.turnos[currentTurno];
            const turnoHoras = turnoConfig.horas;
            const isABC = currentCuadrilla && (['cuadrilla-a','cuadrilla-b','cuadrilla-c'].includes(currentCuadrilla));
            const isMixtoCuadrilla = currentCuadrilla === 'mixto';
            const todayDay = new Date().getDay(); // 0=Sunday
            const allowMixtoExtra = isMixtoCuadrilla && todayDay === 6; // Saturday
            const lunchHour = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.hour : null;
            const lunchMinute = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.minute : 0;
            // Build blocked lunch hours list. If lunch has minute offset > 0, block both the hour and the following hour as lunch span.
            const blockedLunchHours = (lunchHour !== null && currentTurno !== 'mixto') ? [lunchHour] : [];
            
            // If cuadrilla A/B/C, allow reporting early/late hours across day (mark as extra fuera de turno)
            const allHoursToShow = (isABC || allowMixtoExtra) ? Array.from({length:24}, (_,i)=>i) : turnoHoras;
            allHoursToShow.forEach(hour => {
                const displayHour = hour.toString().padStart(2, '0');
                const option = document.createElement('option');
                option.value = displayHour;
                // If the hour contains the lunch (exact hour), annotate it
                const isLunch = blockedLunchHours.includes(hour);
                const isExtra = isABC && !turnoHoras.includes(hour);
                const isMixtoExtra = allowMixtoExtra && isMixtoCuadrilla && !turnoHoras.includes(hour);
                
                if (isLunch) {
                    const mm = lunchMinute.toString().padStart(2, '0');
                    option.textContent = `${displayHour}:00 (Descanso ${lunchHour}:${mm})` + (isExtra || isMixtoExtra ? ' (Extra)' : '');
                    option.dataset.lunch = 'true';
                    option.disabled = true; // prevent selection of lunch hour
                } else {
                    option.textContent = `${displayHour}:00` + (isExtra || isMixtoExtra ? ' (Extra - fuera de turno)' : '');
                }
                hourSelect.appendChild(option);
            });
        }

        function generateExtraHourOptions() {
            const extraHourSelect = document.getElementById('extra-hour');
            if (!extraHourSelect) return;
            extraHourSelect.innerHTML = '<option value="">Hora inicio (opcional)</option>';
            const turnoConfig = SYSTEM_CONFIG.turnos[currentTurno] || null;
            const lunchHour = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.hour : null;
            const lunchMinute = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.minute : 0;
            const blockedLunchHours = (lunchHour !== null && currentTurno !== 'mixto') ? [lunchHour] : [];
            for (let h = 0; h < 24; h++) {
                const display = h.toString().padStart(2, '0');
                const opt = document.createElement('option');
                opt.value = display;
                opt.textContent = `${display}:00`;
                if (blockedLunchHours.includes(h)) { opt.disabled = true; opt.dataset.lunch = 'true'; } // cannot schedule extra during lunch hour(s)
                extraHourSelect.appendChild(opt);
            }
        }

        // Extra staff management
        // Reglas de Horas Extra:
        // - Cuadrillas A, B y C: pueden registrar horas extra el mismo d√≠a (antes o despu√©s del turno); seleccionar la hora de inicio opcionalmente.
        // - Cuadrilla Mixto: solo puede registrar horas extra los s√°bados.
        // - Domingo: no se registran turnos ni horas.
        function initializeExtraStaffForm() {
            const addBtn = document.getElementById('add-extra-btn');
            if (!addBtn) return;
            // Populate extra-hour options
            generateExtraHourOptions();
            addBtn.addEventListener('click', function() {
                const name = document.getElementById('extra-name').value.trim();
                const role = document.getElementById('extra-role').value;
                const hours = parseFloat(document.getElementById('extra-hours').value) || 0;
                const horaVal = document.getElementById('extra-hour').value || '';
                const hora = horaVal ? parseInt(horaVal) : null;

                // Validaciones generales
                const now = new Date();
                const day = now.getDay(); // 0=Domingo, 6=S√°bado
                // Domingo no se registran horas ni inicio de turnos
                if (day === 0) {
                    alert('Hoy es domingo; no se permiten registros de horas o inicio de turnos.');
                    return;
                }
                // Si la cuadrilla es mixto, s√≥lo se permiten extras los s√°bados
                if ((currentCuadrilla === 'mixto' || isMixto) && day !== 6) {
                    alert('La cuadrilla Mixto s√≥lo puede registrar horas extra los s√°bados.');
                    return;
                }
                
                if (!role || hours <= 0) {
                    alert('Por favor ingrese un rol y horas v√°lidas para la persona extra.');
                    return;
                }

                // Validar hora (si es provista) para asegurarnos que es un entero 0..23
                if (hora !== null && (isNaN(hora) || hora < 0 || hora > 23)) {
                    alert('Seleccione una hora v√°lida (00 a 23) si indica la hora de inicio.');
                    return;
                }
                // Prevent registering extras during lunch hour of current turno
                const turnoConfig = SYSTEM_CONFIG.turnos[currentTurno] || {};
                const lunchHour = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.hour : null;
                const lunchMinute = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.minute : 0;
                const blockedLunchHours = (lunchHour === null || currentTurno === 'mixto') ? [] : [lunchHour];
                if (hora !== null && lunchHour !== null && blockedLunchHours.includes(hora)) {
                    alert('No se permiten registros de personal extra durante la hora de descanso.');
                    return;
                }

                // Adding extras does not close or modify the existing shift; we only append extra staff entries.
                extraStaffEntries.push({ name, role, hours, hora: (hora !== null ? hora.toString().padStart(2,'0') : '') });
                renderExtraList();

                // reset inputs
                document.getElementById('extra-name').value = '';
                document.getElementById('extra-role').value = 'montacarguistas';
                document.getElementById('extra-hours').value = '';
            });
            renderExtraList();
        }

        function renderExtraList() {
            const container = document.getElementById('extra-list');
            if (!container) return;
            if (!extraStaffEntries || extraStaffEntries.length === 0) {
                container.innerHTML = 'No hay personal extra registrado';
                return;
            }
            const rows = [];
            rows.push('<table class="data-table"><thead><tr><th>Nombre/ID</th><th>Rol</th><th>Horas</th><th>Hora</th><th>Acci√≥n</th></tr></thead><tbody>');
            extraStaffEntries.forEach((e, idx) => {
                rows.push(`<tr><td>${e.name || '-'}</td><td>${e.role}</td><td>${e.hours}</td><td>${e.hora || '-'}</td><td><button type="button" class="remove-extra" data-index="${idx}">Eliminar</button></td></tr>`);
            });
            rows.push('</tbody></table>');

            const totalCount = extraStaffEntries.reduce((s, e) => s + 1, 0);
            const totalHours = extraStaffEntries.reduce((s, e) => s + (parseFloat(e.hours) || 0), 0);
            container.innerHTML = `<div style="font-size:0.9em; margin-bottom:8px;">Total extras: <strong>${totalCount}</strong> ‚Äî Horas totales: <strong>${totalHours}</strong></div>` + rows.join('');

            // Attach remove handlers
            document.querySelectorAll('.remove-extra').forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    if (!isNaN(idx)) {
                        extraStaffEntries.splice(idx, 1);
                        renderExtraList();
                    }
                });
            });
        }

        function loadExtraEntriesFromSavedShift() {
            const today = new Date().toISOString().split('T')[0];
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            const shift = allShifts[today] && allShifts[today][currentCuadrilla];
            if (shift && shift.extras && Array.isArray(shift.extras)) {
                extraStaffEntries = shift.extras.slice();
            } else {
                extraStaffEntries = [];
            }
            renderExtraList();
        }
        
        function canSubmitStartShift() {
            const turnoConfig = SYSTEM_CONFIG.turnos[currentTurno];
            const now = new Date();
            const startHour = turnoConfig.inicio;
                    const endHour = turnoConfig.fin;
                    const startTime = new Date();
                    startTime.setHours(startHour, 0, 0, 0);

                    // Ajuste para turnos que empiezan antes de la medianoche y terminan despu√©s (overnight)
                    if (startHour > endHour && now.getHours() < startHour) {
                        // Si la hora actual es pasada la medianoche y el turno comenz√≥ ayer, retroceder un d√≠a
                        startTime.setDate(startTime.getDate() - 1);
                    }
            
            const timeDiff = (now - startTime) / (1000 * 60); // diferencia en minutos
            return timeDiff <= SYSTEM_CONFIG.limites.inicioTurno;
        }
        
        function canSubmitHourly(hour) {
            const now = new Date();
            const currentHour = now.getHours().toString().padStart(2, '0');
            
            // Prevent selection when hour equals lunch hour(s) for currentTurno
            const turnoConfig = SYSTEM_CONFIG.turnos[currentTurno];
            const lunchHourNum = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.hour : null;
            const lunchMinuteNum = turnoConfig && turnoConfig.lunch ? turnoConfig.lunch.minute : 0;
            const blockedLunchHours = (lunchHourNum === null || currentTurno === 'mixto') ? [] : [lunchHourNum];
            if (blockedLunchHours.map(h => h.toString().padStart(2,'0')).includes(hour)) return false;

            if (hour !== currentHour) {
                return false; // Solo se puede registrar la hora actual
            }
            
            const currentMinutes = now.getMinutes();
            return currentMinutes <= SYSTEM_CONFIG.limites.registroHorario;
        }
        
        function checkTimeLimits() {
            const startShiftLimit = document.getElementById('start-shift-time-limit');
            const hourlyLimit = document.getElementById('hourly-time-limit');
            
            // Verificar inicio de turno
            if (canSubmitStartShift()) {
                startShiftLimit.className = 'time-limit';
                startShiftLimit.innerHTML = '‚è∞ Tienes 1 hora para registrar el inicio de turno';
                document.getElementById('start-shift-submit').disabled = false;
            } else {
                startShiftLimit.className = 'time-limit expired';
                startShiftLimit.innerHTML = '‚è∞ Tiempo expirado para registro de inicio de turno';
                document.getElementById('start-shift-submit').disabled = true;
            }
            
            // Verificar registro horario
            const currentHour = new Date().getHours().toString().padStart(2, '0');
            if (canSubmitHourly(currentHour)) {
                hourlyLimit.className = 'time-limit';
                hourlyLimit.innerHTML = '‚è∞ Tienes hasta 59 minutos despu√©s de cada hora para registrar total de cajas';
                document.getElementById('hourly-submit').disabled = false;
            } else {
                hourlyLimit.className = 'time-limit expired';
                hourlyLimit.innerHTML = '‚è∞ Tiempo expirado para registro de esta hora';
                document.getElementById('hourly-submit').disabled = true;
            }
        }
        
        function saveShiftData(shiftData) {
            const today = new Date().toISOString().split('T')[0];
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            
            if (!allShifts[today]) {
                allShifts[today] = {};
            }
            
            // Guardar por cuadrilla en lugar de por turno
            allShifts[today][currentCuadrilla] = shiftData;
            localStorage.setItem('shiftData', JSON.stringify(allShifts));
            // Intentar guardar tambi√©n en Firebase Firestore (si est√° inicializado)
            try {
                if (window.db) {
                    // Guardar bajo collection 'shifts', documento por fecha, con campo por cuadrilla
                    window.db.collection('shifts').doc(today).set({ [currentCuadrilla]: shiftData }, { merge: true })
                        .then(() => console.log('Shift saved to Firestore'))
                        .catch(e => console.warn('Firestore saveShiftData error', e));
                }
            } catch (e) {
                console.warn('saveShiftData firebase error', e);
            }
        }
        
        function saveHourlyData(hourlyData) {
            const today = new Date().toISOString().split('T')[0];
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            
            if (!allHourly[today]) {
                allHourly[today] = {};
            }
            
            // Guardar por cuadrilla en lugar de por turno
            if (!allHourly[today][currentCuadrilla]) {
                allHourly[today][currentCuadrilla] = [];
            }
            
            allHourly[today][currentCuadrilla].push(hourlyData);
            localStorage.setItem('hourlyData', JSON.stringify(allHourly));
            // Intentar guardar tambi√©n en Firestore
            try {
                if (window.db) {
                    const docRef = window.db.collection('hourly').doc(today);
                    const FieldValue = firebase.firestore.FieldValue;
                    // A√±adir al array de la cuadrilla at√≥mico
                    docRef.set({ [currentCuadrilla]: FieldValue.arrayUnion(hourlyData) }, { merge: true })
                        .then(() => console.log('Hourly saved to Firestore'))
                        .catch(e => console.warn('Firestore saveHourlyData error', e));
                }
            } catch (e) {
                console.warn('saveHourlyData firebase error', e);
            }
        }
        
        function updateProgress() {
            const today = new Date().toISOString().split('T')[0];
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            const cuadrillaData = allHourly[today] ? allHourly[today][currentCuadrilla] : [];
            
            let totalCajas = 0;
            if (cuadrillaData) {
                totalCajas = cuadrillaData.reduce((sum, entry) => sum + entry.cajas, 0);
            }
            
            const progressFill = document.getElementById('progress-fill');
            const currentCount = document.getElementById('current-count');
            
            const metaTurno = currentShiftData ? currentShiftData.metaTurno : SYSTEM_CONFIG.turnos[currentTurno].metaBase;
            const progress = (totalCajas / metaTurno) * 100;
            progressFill.style.width = `${Math.min(progress, 100)}%`;
            currentCount.textContent = totalCajas;
        }
        
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time-display').textContent = 
                `Hora: ${now.toLocaleTimeString()}`;
        }
        
        function initializeProgressCharts() {
            // Destroy existing charts to avoid Canvas reuse errors
            try { if (window.turnProgressChart) { window.turnProgressChart.destroy(); window.turnProgressChart = null; } } catch(e) { console.warn('Could not destroy turnProgressChart', e); }
            try { if (window.efficiencyChart) { window.efficiencyChart.destroy(); window.efficiencyChart = null; } } catch(e) { console.warn('Could not destroy efficiencyChart', e); }
            // Gr√°fico de progreso por turno
            const progressCtx = document.getElementById('turn-progress-chart').getContext('2d');
            window.turnProgressChart = new Chart(progressCtx, {
                type: 'bar',
                data: {
                    labels: ['Turno 1', 'Turno 2', 'Turno 3', 'Mixto'],
                    datasets: [{
                        label: 'Cajas Acumulado',
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            THEME.turno1,
                            THEME.turno2,
                            THEME.turno3,
                            THEME.mixto
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: SYSTEM_CONFIG.metas.diaria
                        }
                    }
                }
            });
            
            // Gr√°fico de eficiencia
            const efficiencyCtx = document.getElementById('efficiency-chart').getContext('2d');
            window.efficiencyChart = new Chart(efficiencyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Real',
                            data: [],
                            borderColor: THEME[ currentTurno ? ('turno'+currentTurno) : 'turno1' ],
                                backgroundColor: `${THEME[ currentTurno ? ('turno'+currentTurno) : 'turno1' ]}20`,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Esperado',
                            data: [],
                            borderColor: THEME.success,
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function initializeAdminCharts() {
            // Destroy existing admin charts to avoid Canvas reuse errors
            try { if (window.adminTurnProgressChart) { window.adminTurnProgressChart.destroy(); window.adminTurnProgressChart = null; } } catch(e) { console.warn('Could not destroy adminTurnProgressChart', e); }
            try { if (window.adminEfficiencyChart) { window.adminEfficiencyChart.destroy(); window.adminEfficiencyChart = null; } } catch(e) { console.warn('Could not destroy adminEfficiencyChart', e); }
            try { if (window.adminTurnEfficiencyChart) { window.adminTurnEfficiencyChart.destroy(); window.adminTurnEfficiencyChart = null; } } catch(e) { console.warn('Could not destroy adminTurnEfficiencyChart', e); }
            try { if (window.attendanceChart) { window.attendanceChart.destroy(); window.attendanceChart = null; } } catch(e) { console.warn('Could not destroy attendanceChart', e); }
            try { if (window.goalsChart) { window.goalsChart.destroy(); window.goalsChart = null; } } catch(e) { console.warn('Could not destroy goalsChart', e); }
            // Gr√°fico de progreso por turno (admin)
            const adminProgressCtx = document.getElementById('admin-turn-progress-chart').getContext('2d');
            window.adminTurnProgressChart = new Chart(adminProgressCtx, {
                type: 'bar',
                data: {
                    labels: ['Turno 1', 'Turno 2', 'Turno 3', 'Mixto'],
                    datasets: [{
                        label: 'Cajas Acumulado',
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            THEME.turno1,
                            THEME.turno2,
                            THEME.turno3,
                            THEME.mixto
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: SYSTEM_CONFIG.metas.diaria
                        }
                    }
                }
            });
            
            // Gr√°fico de eficiencia (admin)
            const adminEfficiencyCtx = document.getElementById('admin-efficiency-chart').getContext('2d');
            window.adminEfficiencyChart = new Chart(adminEfficiencyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Real',
                            data: [],
                            borderColor: THEME.cuadrillaA,
                                backgroundColor: `rgba(${parseInt(THEME.cuadrillaA.slice(1,3),16)}, ${parseInt(THEME.cuadrillaA.slice(3,5),16)}, ${parseInt(THEME.cuadrillaA.slice(5,7),16)}, 0.1)`,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Esperado',
                            data: [],
                            borderColor: THEME.success,
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Chart: Eficiencia por Turno (admin)
            const adminTurnEffCtx = document.getElementById('admin-turn-efficiency-chart').getContext('2d');
            window.adminTurnEfficiencyChart = new Chart(adminTurnEffCtx, {
                type: 'bar',
                data: {
                    labels: ['Turno 1', 'Turno 2', 'Turno 3', 'Mixto'],
                    datasets: [{
                        label: '% Cumplimiento',
                        data: [0,0,0,0],
                        backgroundColor: [THEME.turno1, THEME.turno2, THEME.turno3, THEME.mixto]
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 150 } }
                }
            });
            
            // Gr√°fico de asistencia
            const attendanceCtx = document.getElementById('attendance-chart').getContext('2d');
            window.attendanceChart = new Chart(attendanceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Presentes', 'Ausentes'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [THEME.success, THEME.danger]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Gr√°fico de cumplimiento de metas
            const goalsCtx = document.getElementById('goals-chart').getContext('2d');
            window.goalsChart = new Chart(goalsCtx, {
                type: 'radar',
                data: {
                    labels: ['Turno 1', 'Turno 2', 'Turno 3', 'Mixto'],
                    datasets: [{
                        label: 'Cumplimiento %',
                        data: [0, 0, 0, 0],
                        backgroundColor: `rgba(${parseInt(THEME.cuadrillaA.slice(1,3),16)}, ${parseInt(THEME.cuadrillaA.slice(3,5),16)}, ${parseInt(THEME.cuadrillaA.slice(5,7),16)}, 0.2)`,
                        borderColor: THEME.cuadrillaA,
                        pointBackgroundColor: THEME.cuadrillaA
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        function updateProgressView() {
            const today = new Date().toISOString().split('T')[0];
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            
            // Obtener datos por turno basado en la cuadrilla y su turno actual
            let turno1Progress = 0, turno2Progress = 0, turno3Progress = 0, mixtoProgress = 0;
            let turno1Meta = SYSTEM_CONFIG.turnos['1'].metaBase;
            let turno2Meta = SYSTEM_CONFIG.turnos['2'].metaBase;
            let turno3Meta = SYSTEM_CONFIG.turnos['3'].metaBase;
            let mixtoMeta = SYSTEM_CONFIG.turnos['mixto'].metaBase;
            
            if (allHourly[today]) {
                // Para cada cuadrilla, determinar su turno y sumar a ese turno
                Object.keys(allHourly[today]).forEach(cuadrilla => {
                    const cuadrillaData = allHourly[today][cuadrilla];
                    const totalCajas = cuadrillaData.reduce((sum, entry) => sum + entry.cajas, 0);
                    
                    if (cuadrilla === 'mixto') {
                        mixtoProgress += totalCajas;
                    } else {
                        // Obtener el turno actual de esta cuadrilla
                        const turno = getCurrentTurnoForCuadrilla(cuadrilla);
                        if (turno === '1') turno1Progress += totalCajas;
                        else if (turno === '2') turno2Progress += totalCajas;
                        else if (turno === '3') turno3Progress += totalCajas;
                    }
                });
            }
            
            // Obtener metas ajustadas de los turnos
            if (allShifts[today]) {
                Object.keys(allShifts[today]).forEach(cuadrilla => {
                    const shiftData = allShifts[today][cuadrilla];
                    if (shiftData && shiftData.metaTurno) {
                        const turno = getCurrentTurnoForCuadrilla(cuadrilla);
                        if (turno === '1') turno1Meta = shiftData.metaTurno;
                        else if (turno === '2') turno2Meta = shiftData.metaTurno;
                        else if (turno === '3') turno3Meta = shiftData.metaTurno;
                        else if (cuadrilla === 'mixto') mixtoMeta = shiftData.metaTurno;
                    }
                });
            }
            
            const totalDia = turno1Progress + turno2Progress + turno3Progress + mixtoProgress;
            
            // Actualizar displays
            document.getElementById('turno1-progress').textContent = turno1Progress;
            document.getElementById('turno2-progress').textContent = turno2Progress;
            document.getElementById('turno3-progress').textContent = turno3Progress;
            document.getElementById('turno-mixto-progress').textContent = mixtoProgress;
            document.getElementById('total-dia-progress').textContent = totalDia;

            // Per-turn efficiency badges
            const t1Perc = turno1Meta > 0 ? (turno1Progress / turno1Meta) * 100 : null;
            const t2Perc = turno2Meta > 0 ? (turno2Progress / turno2Meta) * 100 : null;
            const t3Perc = turno3Meta > 0 ? (turno3Progress / turno3Meta) * 100 : null;
            const tmPerc = mixtoMeta > 0 ? (mixtoProgress / mixtoMeta) * 100 : null;
            function setEfficiencyBadge(id, pct) {
                const el = document.getElementById(id);
                if (!el) return;
                if (pct === null) { el.textContent = '-'; el.className = 'summary-efficiency'; return; }
                el.textContent = `${pct.toFixed(1)}%`;
                el.className = 'summary-efficiency ' + (pct >= 100 ? 'efficiency-high' : (pct >= 80 ? 'efficiency-medium' : 'efficiency-low'));
            }
            setEfficiencyBadge('turno1-efficiency', t1Perc);
            setEfficiencyBadge('turno2-efficiency', t2Perc);
            setEfficiencyBadge('turno3-efficiency', t3Perc);
            setEfficiencyBadge('turno-mixto-efficiency', tmPerc);
            
            // Actualizar estado de metas
            updateMetaStatus('turno1', turno1Progress, turno1Meta);
            updateMetaStatus('turno2', turno2Progress, turno2Meta);
            updateMetaStatus('turno3', turno3Progress, turno3Meta);
            updateMetaStatus('turno-mixto', mixtoProgress, mixtoMeta);
            updateMetaStatus('total', totalDia, SYSTEM_CONFIG.metas.diaria);
            
            // Actualizar info del turno mixto si es visible
            if (isMixto) {
                document.getElementById('mixto-turno1').textContent = turno1Progress;
                document.getElementById('mixto-turno2').textContent = turno2Progress;
                document.getElementById('mixto-turno3').textContent = turno3Progress;
                document.getElementById('mixto-total').textContent = totalDia;
            }
            
            // Actualizar gr√°fico de progreso
            if (window.turnProgressChart) {
                window.turnProgressChart.data.datasets[0].data = [turno1Progress, turno2Progress, turno3Progress, mixtoProgress];
                window.turnProgressChart.update();
            }
            
            // Actualizar gr√°fico de eficiencia
            updateEfficiencyChart();
        }
        
        function getMetaStatusHTML(progreso, meta) {
            if (!meta || meta <= 0) {
                return `<div>No registrada</div>`;
            }
            const porcentaje = (progreso / meta) * 100;
            if (porcentaje >= 100) {
                return `<div class="success-banner">‚úÖ Meta superada (${porcentaje.toFixed(1)}%)</div>`;
            } else if (porcentaje >= 80) {
                return `<div class="warning-banner">‚ö†Ô∏è Cerca de la meta (${porcentaje.toFixed(1)}%)</div>`;
            } else {
                return `<div>${porcentaje.toFixed(1)}% de la meta</div>`;
            }
        }

        function updateMetaStatus(turnoId, progreso, meta) {
            const elemento = document.getElementById(`${turnoId}-meta-status`);
            if (elemento) elemento.innerHTML = getMetaStatusHTML(progreso, meta);
        }
        
        function getCurrentTurnoForCuadrilla(cuadrilla) {
                    if (cuadrilla === 'mixto') return 'mixto';
                    // Usamos rotaci√≥n de 15 d√≠as a partir del epochDate y la baseOrder
                    const now = new Date();
                    const rotIdx = getRotationIndexForDate(now);
                    const base = (SYSTEM_CONFIG.rotation && Array.isArray(SYSTEM_CONFIG.rotation.baseOrder) && SYSTEM_CONFIG.rotation.baseOrder.length === 3) ? SYSTEM_CONFIG.rotation.baseOrder : ['cuadrilla-a', 'cuadrilla-b', 'cuadrilla-c'];
                    const pos = base.indexOf(cuadrilla);
                    if (pos === -1) {
                        // Cuadrilla desconocida -> fallback: cuadrilla-a
                        return '1';
                    }
                    // calcular turno a partir de posici√≥n y rotIdx: turno = ((pos - rotIdx) mod 3) + 1
                    const turnoNum = ((pos - rotIdx + 3) % 3) + 1;
                    return turnoNum.toString();
        }
        
                async function updateAdminDashboard(date) {
                    const today = date || document.getElementById('export-date').value || new Date().toISOString().split('T')[0];
                    let allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
                    let allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');

                    // Si Live est√° activado y Firestore est√° disponible, obtener datos remotos
                    try {
                        const live = localStorage.getItem('adminLive') === 'true';
                        if (live && window.db) {
                            const shiftsDoc = await window.db.collection('shifts').doc(today).get();
                            const hourlyDoc = await window.db.collection('hourly').doc(today).get();
                            if (shiftsDoc && shiftsDoc.exists) {
                                // shiftsDoc.data() tiene estructura { cuadrilla: shiftData, ... }
                                allShifts = { [today]: shiftsDoc.data() };
                            }
                            if (hourlyDoc && hourlyDoc.exists) {
                                allHourly = { [today]: hourlyDoc.data() };
                            }
                        }
                    } catch (e) {
                        console.warn('Error fetching live data from Firestore', e);
                    }
            
            // Calcular m√©tricas
            let totalProduction = 0;
            let totalAttendance = 0;
            let lateRecords = 0;
            
            // Progreso por turno
            let turno1Progress = 0, turno2Progress = 0, turno3Progress = 0, mixtoProgress = 0;
            let cuadrillasPorTurno = {
                '1': 'Sin datos',
                '2': 'Sin datos',
                '3': 'Sin datos',
                'mixto': 'Sin datos'
            };
            
            if (allHourly[today]) {
                Object.values(allHourly[today]).forEach(cuadrillaData => {
                    cuadrillaData.forEach(entry => {
                        totalProduction += entry.cajas;
                        if (entry.isLate) lateRecords++;
                    });
                });
                
                // Calcular por turno y determinar cuadrillas
                Object.keys(allHourly[today]).forEach(cuadrilla => {
                    const cuadrillaData = allHourly[today][cuadrilla];
                    const totalCajas = cuadrillaData.reduce((sum, entry) => sum + entry.cajas, 0);
                    
                    if (cuadrilla === 'mixto') {
                        mixtoProgress += totalCajas;
                        cuadrillasPorTurno['mixto'] = 'Turno Mixto';
                    } else {
                        const turno = getCurrentTurnoForCuadrilla(cuadrilla);
                        if (turno === '1') {
                            turno1Progress += totalCajas;
                            cuadrillasPorTurno['1'] = SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre;
                        } else if (turno === '2') {
                            turno2Progress += totalCajas;
                            cuadrillasPorTurno['2'] = SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre;
                        } else if (turno === '3') {
                            turno3Progress += totalCajas;
                            cuadrillasPorTurno['3'] = SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre;
                        }
                    }
                });
            }
            
            // Asistencia
            if (allShifts[today]) {
                Object.values(allShifts[today]).forEach(cuadrillaData => {
                    totalAttendance += cuadrillaData.attendance.montas + cuadrillaData.attendance.auxiliares + 
                                      cuadrillaData.attendance.auditores + cuadrillaData.attendance.alm +
                                      (cuadrillaData.attendance.analistas || 0);
                });
            }
            
            // Actualizar estad√≠sticas (productos y asistencia)
            document.getElementById('total-production').textContent = totalProduction;
            document.getElementById('total-attendance').textContent = totalAttendance;
            const lateEl = document.getElementById('late-records');
            if (lateEl) lateEl.textContent = lateRecords;

            // Calcular extras
            let extraCount = 0;
            let extraHours = 0;
            const extrasByRole = { montacarguistas: 0, almacenistas: 0, auditores: 0, auxiliares: 0, analistas: 0, otro: 0 };
            if (allShifts[today]) {
                Object.values(allShifts[today]).forEach(shift => {
                    if (shift && shift.extras && Array.isArray(shift.extras)) {
                        shift.extras.forEach(e => {
                            extraCount += 1;
                            extraHours += parseFloat(e.hours || 0);
                            if (e.role && extrasByRole[e.role] !== undefined) {
                                extrasByRole[e.role] += 1;
                            } else {
                                extrasByRole.otro += 1;
                            }
                        });
                    }
                });
            }

            const adminExtraEl = document.getElementById('admin-extra-count');
            const adminExtraHoursEl = document.getElementById('admin-extra-hours');
            if (adminExtraEl) adminExtraEl.textContent = extraCount;
            if (adminExtraHoursEl) adminExtraHoursEl.textContent = extraHours;
            const breakdownEl = document.getElementById('admin-extra-breakdown-content');
            if (breakdownEl) {
                if (extraCount === 0) {
                    breakdownEl.textContent = 'No hay personal extra';
                    document.getElementById('admin-extra-breakdown').style.display = 'none';
                } else {
                        const roleNames = {montacarguistas:'Montacarguistas', almacenistas:'Almacenistas', auditores:'Auditores', auxiliares:'Auxiliares', analistas:'Analistas', otro:'Otro'};
                        const lines = [];
                        Object.keys(extrasByRole).forEach(role => {
                            if (extrasByRole[role] > 0) lines.push(`${roleNames[role] || role}: ${extrasByRole[role]}`);
                        });
                    breakdownEl.innerHTML = lines.join('<br/>');
                    document.getElementById('admin-extra-breakdown').style.display = 'block';
                }
            }
            
            // Actualizar informaci√≥n de cuadrillas
            const ct1El = document.getElementById('cuadrilla-turno1'); if (ct1El) ct1El.textContent = cuadrillasPorTurno['1'];
            const ct2El = document.getElementById('cuadrilla-turno2'); if (ct2El) ct2El.textContent = cuadrillasPorTurno['2'];
            const ct3El = document.getElementById('cuadrilla-turno3'); if (ct3El) ct3El.textContent = cuadrillasPorTurno['3'];
            const ctMixtoEl = document.getElementById('cuadrilla-mixto'); if (ctMixtoEl) ctMixtoEl.textContent = cuadrillasPorTurno['mixto'];

            // Calcular metas ajustadas por turno a partir de los shifts registrados (solo los que registraron una meta)
            let turno1MetaSum = 0, turno2MetaSum = 0, turno3MetaSum = 0, mixtoMetaSum = 0;
            if (allShifts[today]) {
                Object.keys(allShifts[today]).forEach(cuadrilla => {
                    const shiftData = allShifts[today][cuadrilla];
                    if (shiftData && shiftData.metaTurno) {
                        if (cuadrilla === 'mixto') mixtoMetaSum += shiftData.metaTurno;
                        else {
                            const turno = getCurrentTurnoForCuadrilla(cuadrilla);
                            if (turno === '1') turno1MetaSum += shiftData.metaTurno;
                            else if (turno === '2') turno2MetaSum += shiftData.metaTurno;
                            else if (turno === '3') turno3MetaSum += shiftData.metaTurno;
                        }
                    }
                });
            }

            // Actualizar Mixto Admin breakdown
            const mixtoAdminEl1 = document.getElementById('mixto-admin-turno1');
            const mixtoAdminEl2 = document.getElementById('mixto-admin-turno2');
            const mixtoAdminEl3 = document.getElementById('mixto-admin-turno3');
            const mixtoAdminTotal = document.getElementById('mixto-admin-total');
            if (mixtoAdminEl1) mixtoAdminEl1.textContent = turno1Progress;
            if (mixtoAdminEl2) mixtoAdminEl2.textContent = turno2Progress;
            if (mixtoAdminEl3) mixtoAdminEl3.textContent = turno3Progress;
            if (mixtoAdminTotal) mixtoAdminTotal.textContent = (turno1Progress + turno2Progress + turno3Progress + mixtoProgress);
            if (document.getElementById('mixto-info-admin')) document.getElementById('mixto-info-admin').style.display = 'block';
            
            // Actualizar valores de meta por turno en la vista Admin
            const adminMetaVal1 = document.getElementById('admin-turno1-meta-value');
            const adminMetaVal2 = document.getElementById('admin-turno2-meta-value');
            const adminMetaVal3 = document.getElementById('admin-turno3-meta-value');
            const adminMetaValMixto = document.getElementById('admin-turno-mixto-meta-value');
            const adminTotalEstimated = document.getElementById('admin-total-estimated-meta');
            // Also compute meta por hora (excluyendo hora de descanso)
            function computeMetaPerHourForTurno(turnoKey, metaValue){
                const tConfig = SYSTEM_CONFIG.turnos[turnoKey];
                const horas = tConfig ? (tConfig.horas || []) : [];
                const lunchHour = tConfig && tConfig.lunch ? tConfig.lunch.hour : null;
                const reporting = horas.filter(h => h !== lunchHour);
                const hoursCount = reporting.length || horas.length || 1;
                const perHour = Math.round((metaValue || tConfig.metaBase) / hoursCount);
                return perHour;
            }
            const metaHora1 = computeMetaPerHourForTurno('1', turno1MetaSum || SYSTEM_CONFIG.turnos['1'].metaBase);
            const metaHora2 = computeMetaPerHourForTurno('2', turno2MetaSum || SYSTEM_CONFIG.turnos['2'].metaBase);
            const metaHora3 = computeMetaPerHourForTurno('3', turno3MetaSum || SYSTEM_CONFIG.turnos['3'].metaBase);
            const metaHoraMixto = computeMetaPerHourForTurno('mixto', mixtoMetaSum || SYSTEM_CONFIG.turnos['mixto'].metaBase);

            if (adminMetaVal1) adminMetaVal1.innerHTML = (turno1MetaSum > 0 ? turno1MetaSum : '-') + `<br/><small>Meta/h: ${metaHora1}</small>`;
            if (adminMetaVal2) adminMetaVal2.innerHTML = (turno2MetaSum > 0 ? turno2MetaSum : '-') + `<br/><small>Meta/h: ${metaHora2}</small>`;
            if (adminMetaVal3) adminMetaVal3.innerHTML = (turno3MetaSum > 0 ? turno3MetaSum : '-') + `<br/><small>Meta/h: ${metaHora3}</small>`;
            if (adminMetaValMixto) adminMetaValMixto.innerHTML = (mixtoMetaSum > 0 ? mixtoMetaSum : '-') + `<br/><small>Meta/h: ${metaHoraMixto}</small>`;
            const estimatedTotal = turno1MetaSum + turno2MetaSum + turno3MetaSum + mixtoMetaSum;
            if (adminTotalEstimated) adminTotalEstimated.textContent = estimatedTotal;
            const gapEl = document.getElementById('admin-daily-gap');
            const diff = SYSTEM_CONFIG.metas.diaria - estimatedTotal;
            if (gapEl) gapEl.textContent = diff > 0 ? `Faltan ${diff} cajas para alcanzar ${SYSTEM_CONFIG.metas.diaria}` : `Superaron por ${Math.abs(diff)} cajas`;

            // Actualizar estado predictivo: si con las metas registradas alcanzar√≠an la meta diaria
            updateMetaStatus('admin-total-predicted', estimatedTotal, SYSTEM_CONFIG.metas.diaria);
            // Show admin alerts for missing profiles
            updateAdminMissingProfiles(today);
            // Recompute/update global efficiency now that estimatedTotal is known (prevent ReferenceError)
            try {
                const fallbackExpected = 24 * SYSTEM_CONFIG.metas.porHora; // 24 hours fallback
                const expectedBasedOnMeta = (typeof estimatedTotal === 'number' && estimatedTotal > 0) ? estimatedTotal : fallbackExpected;
                const globalEfficiency = expectedBasedOnMeta > 0 ? (totalProduction / expectedBasedOnMeta) * 100 : 0;
                const globalEffEl = document.getElementById('global-efficiency');
                if (globalEffEl) globalEffEl.textContent = `${globalEfficiency.toFixed(1)}%`;
            } catch (e) { console.warn('Error computing global efficiency', e); }
            
            // Actualizar gr√°ficos
            if (window.adminTurnProgressChart) {
                window.adminTurnProgressChart.data.datasets[0].data = [turno1Progress, turno2Progress, turno3Progress, mixtoProgress];
                window.adminTurnProgressChart.update();
            }
            if (window.adminTurnEfficiencyChart) {
                // Use the turno meta sums if present, otherwise fall back to system metaBase
                const meta1 = turno1MetaSum > 0 ? turno1MetaSum : SYSTEM_CONFIG.turnos['1'].metaBase;
                const meta2 = turno2MetaSum > 0 ? turno2MetaSum : SYSTEM_CONFIG.turnos['2'].metaBase;
                const meta3 = turno3MetaSum > 0 ? turno3MetaSum : SYSTEM_CONFIG.turnos['3'].metaBase;
                const metaM = mixtoMetaSum > 0 ? mixtoMetaSum : SYSTEM_CONFIG.turnos['mixto'].metaBase;
                const p1 = meta1 > 0 ? (turno1Progress / meta1) * 100 : 0;
                const p2 = meta2 > 0 ? (turno2Progress / meta2) * 100 : 0;
                const p3 = meta3 > 0 ? (turno3Progress / meta3) * 100 : 0;
                const pm = metaM > 0 ? (mixtoProgress / metaM) * 100 : 0;
                window.adminTurnEfficiencyChart.data.datasets[0].data = [Math.round(p1*10)/10, Math.round(p2*10)/10, Math.round(p3*10)/10, Math.round(pm*10)/10];
                window.adminTurnEfficiencyChart.update();
            }
            
            if (window.attendanceChart) {
                // Calcular total staff esperado din√°micamente sumando targets por cuadrilla
                let totalStaff = 0;
                Object.keys(SYSTEM_CONFIG.cuadrillas).forEach(cuadrilla => {
                    // Para cada cuadrilla, determinar si est√° en turno mixto u otro
                    const turno = getCurrentTurnoForCuadrilla(cuadrilla);
                    if (turno === 'mixto') {
                        totalStaff += SYSTEM_CONFIG.personal.mixto.montacarguistas + SYSTEM_CONFIG.personal.mixto.almacenistas + SYSTEM_CONFIG.personal.mixto.auditores + SYSTEM_CONFIG.personal.mixto.auxiliares + (SYSTEM_CONFIG.personal.mixto.analistas || 0);
                    } else {
                        totalStaff += SYSTEM_CONFIG.personal.normal.montacarguistas + SYSTEM_CONFIG.personal.normal.almacenistas + SYSTEM_CONFIG.personal.normal.auditores + SYSTEM_CONFIG.personal.normal.auxiliares;
                    }
                });
                // Incluir el turno mixto si existe
                if (SYSTEM_CONFIG.coordinadores && SYSTEM_CONFIG.coordinadores.mixto && SYSTEM_CONFIG.coordinadores.mixto.length > 0) {
                    totalStaff += SYSTEM_CONFIG.personal.mixto.montacarguistas + SYSTEM_CONFIG.personal.mixto.almacenistas + SYSTEM_CONFIG.personal.mixto.auditores + SYSTEM_CONFIG.personal.mixto.auxiliares + (SYSTEM_CONFIG.personal.mixto.analistas || 0);
                }

                const absent = Math.max(totalStaff - totalAttendance, 0);
                window.attendanceChart.data.datasets[0].data = [totalAttendance, absent];
                window.attendanceChart.update();
            }
            
            if (window.goalsChart) {
                const cumplimiento1 = (turno1Progress / SYSTEM_CONFIG.turnos['1'].metaBase) * 100;
                const cumplimiento2 = (turno2Progress / SYSTEM_CONFIG.turnos['2'].metaBase) * 100;
                const cumplimiento3 = (turno3Progress / SYSTEM_CONFIG.turnos['3'].metaBase) * 100;
                const cumplimientoMixto = (mixtoProgress / SYSTEM_CONFIG.turnos['mixto'].metaBase) * 100;
                window.goalsChart.data.datasets[0].data = [
                    Math.min(cumplimiento1, 100),
                    Math.min(cumplimiento2, 100),
                    Math.min(cumplimiento3, 100),
                    Math.min(cumplimientoMixto, 100)
                ];
                window.goalsChart.update();
            }
            // Update admin Turn Efficiency chart if present
            if (window.adminTurnEfficiencyChart) {
                const p1 = turno1Meta > 0 ? (turno1Progress / turno1Meta) * 100 : 0;
                const p2 = turno2Meta > 0 ? (turno2Progress / turno2Meta) * 100 : 0;
                const p3 = turno3Meta > 0 ? (turno3Progress / turno3Meta) * 100 : 0;
                const pm = mixtoMeta > 0 ? (mixtoProgress / mixtoMeta) * 100 : 0;
                window.adminTurnEfficiencyChart.data.datasets[0].data = [Math.round(p1*10)/10, Math.round(p2*10)/10, Math.round(p3*10)/10, Math.round(pm*10)/10];
                window.adminTurnEfficiencyChart.update();
            }
            
            // Actualizar campos resumen por turno en panel Admin
            const aT1 = document.getElementById('admin-turno1-progress');
            const aT2 = document.getElementById('admin-turno2-progress');
            const aT3 = document.getElementById('admin-turno3-progress');
            const aTMixto = document.getElementById('admin-turno-mixto-progress');
            const aTotal = document.getElementById('admin-total-dia-progress');
            if (aT1) aT1.textContent = turno1Progress;
            if (aT2) aT2.textContent = turno2Progress;
            if (aT3) aT3.textContent = turno3Progress;
            if (aTMixto) aTMixto.textContent = mixtoProgress;
            if (aTotal) aTotal.textContent = totalDia;

            // Actualizar estados de meta para la vista Admin
            updateMetaStatus('admin-turno1', turno1Progress, turno1MetaSum);
            updateMetaStatus('admin-turno2', turno2Progress, turno2MetaSum);
            updateMetaStatus('admin-turno3', turno3Progress, turno3MetaSum);
            updateMetaStatus('admin-turno-mixto', mixtoProgress, mixtoMetaSum);
            updateMetaStatus('admin-total', totalDia, SYSTEM_CONFIG.metas.diaria);

            // Update visual status classes for admin rows (linear view)
            function setAdminRowStatus(rowId, progreso, meta) {
                const row = document.getElementById(rowId);
                if (!row) return;
                const porcentaje = meta > 0 ? (progreso / meta) * 100 : 0;
                row.classList.remove('status-low','status-ok','status-success');
                if (porcentaje >= 100) row.classList.add('status-success');
                else if (porcentaje >= 80) row.classList.add('status-ok');
                else row.classList.add('status-low');
            }

            // Update percent text and fill bars
            function updateRowProgress(rowIdSuffix, progreso, meta) {
                const percentEl = document.getElementById(`admin-${rowIdSuffix}-percent`);
                const fillEl = document.getElementById(`admin-progress-fill-${rowIdSuffix}`);
                const rowId = `admin-row-${rowIdSuffix}`;
                const porcentaje = meta > 0 ? (progreso / meta) * 100 : null;
                if (percentEl) percentEl.textContent = porcentaje !== null ? `${porcentaje.toFixed(1)}%` : '-';
                if (fillEl) fillEl.style.width = porcentaje !== null ? `${Math.min(porcentaje, 100)}%` : `0%`;
                // Set color of fill based on turno or total
                if (fillEl) {
                    let color = 'var(--primary-color)';
                    if (rowIdSuffix === 'turno1') color = SYSTEM_CONFIG.turnos['1'].color;
                    else if (rowIdSuffix === 'turno2') color = SYSTEM_CONFIG.turnos['2'].color;
                    else if (rowIdSuffix === 'turno3') color = SYSTEM_CONFIG.turnos['3'].color;
                    else if (rowIdSuffix === 'turno-mixto') color = SYSTEM_CONFIG.turnos['mixto'].color;
                    fillEl.style.backgroundColor = color;
                }
                // set status class on the row
                setAdminRowStatus(rowId, progreso, meta);
            }

            updateRowProgress('turno1', turno1Progress, turno1MetaSum);
            updateRowProgress('turno2', turno2Progress, turno2MetaSum);
            updateRowProgress('turno3', turno3Progress, turno3MetaSum);
            updateRowProgress('turno-mixto', mixtoProgress, mixtoMetaSum);
            updateRowProgress('total', estimatedTotal, SYSTEM_CONFIG.metas.diaria);

            // Apply highlight / filter for active turno if toggles are set
            const highlightToggle = document.getElementById('admin-highlight-active-toggle');
            const filterToggle = document.getElementById('admin-filter-active-toggle');
            const activeKey = getActiveTurnoKey();
            ['turno1','turno2','turno3','turno-mixto'].forEach(key => {
                const row = document.getElementById(`admin-row-${key}`);
                if (!row) return;
                if (highlightToggle && highlightToggle.checked) {
                    if ((activeKey === '1' && key==='turno1') || (activeKey === '2' && key==='turno2') || (activeKey === '3' && key==='turno3') || (activeKey==='mixto' && key==='turno-mixto')) {
                        row.classList.add('active-row');
                    } else {
                        row.classList.remove('active-row');
                    }
                } else {
                    row.classList.remove('active-row');
                }
                if (filterToggle && filterToggle.checked) {
                    if ((activeKey === '1' && key!=='turno1') || (activeKey === '2' && key!=='turno2') || (activeKey === '3' && key!=='turno3') || (activeKey==='mixto' && key!=='turno-mixto')) {
                        row.style.display = 'none';
                    } else {
                        row.style.display = '';
                    }
                } else {
                    row.style.display = '';
                }
            });

            updateAdminEfficiencyChart(today);
            updateDataPreview();
            updateAdminHourlyTable(today);
            updateAdminExtrasTable(today);
            updateAdminCuadrillaDetails(today);

            // Turno activo and tardy calculations removed per user preference to shorten the dashboard
        }
        
        function updateEfficiencyChart() {
            const today = new Date().toISOString().split('T')[0];
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            const cuadrillaData = allHourly[today] ? allHourly[today][currentCuadrilla] : [];
            
            const hours = [];
            const realData = [];
            const expectedData = [];
            
            cuadrillaData.forEach(entry => {
                hours.push(`${entry.hour}:00`);
                realData.push(entry.cajas);
                
                // Calcular meta por hora basada en la meta del turno
                const metaHora = currentShiftData ? 
                    Math.round(currentShiftData.metaTurno / 7) : 
                    Math.round(SYSTEM_CONFIG.metas.porHora);
                expectedData.push(metaHora);
            });
            
            if (window.efficiencyChart) {
                window.efficiencyChart.data.labels = hours;
                window.efficiencyChart.data.datasets[0].data = realData;
                window.efficiencyChart.data.datasets[1].data = expectedData;
                window.efficiencyChart.update();
            }
        }
        
        function updateAdminEfficiencyChart(date) {
            const today = date || new Date().toISOString().split('T')[0];
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            
            const hours = [];
            const realData = [];
            const expectedData = [];
            
            // Combinar datos de todos los turnos
            for (let i = 0; i < 24; i++) {
                const hour = i.toString().padStart(2, '0');
                hours.push(`${hour}:00`);
                
                let totalCajas = 0;
                Object.values(allHourly[today] || {}).forEach(cuadrillaData => {
                    cuadrillaData.forEach(entry => {
                        if (entry.hour === hour) {
                            totalCajas += entry.cajas;
                        }
                    });
                });
                
                realData.push(totalCajas);
                expectedData.push(SYSTEM_CONFIG.metas.porHora);
            }
            
            if (window.adminEfficiencyChart) {
                window.adminEfficiencyChart.data.labels = hours;
                window.adminEfficiencyChart.data.datasets[0].data = realData;
                window.adminEfficiencyChart.data.datasets[1].data = expectedData;
                window.adminEfficiencyChart.update();
            }
        }

        function updateAdminHourlyTable(date) {
            const today = date || document.getElementById('export-date').value || new Date().toISOString().split('T')[0];
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            const hourlyData = (allHourly[today] || {});
            const container = document.getElementById('admin-hourly-table');

            const rows = [];
            rows.push('<table class="data-table"><thead><tr><th>Cuadrilla</th><th>Turno</th><th>Hora</th><th>Cajas</th><th>Coordinador</th><th>Timestamp</th><th>Tard√≠o</th></tr></thead><tbody>');

            Object.keys(hourlyData).forEach(cuadrilla => {
                const entries = hourlyData[cuadrilla] || [];
                entries.forEach(entry => {
                    const turno = entry.turno || getCurrentTurnoForCuadrilla(cuadrilla);
                    const sheetName = cuadrilla === 'mixto' ? 'Mixto' : (SYSTEM_CONFIG.cuadrillas[cuadrilla] ? SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre : cuadrilla);
                    rows.push(`<tr><td>${sheetName}</td><td>${turno}</td><td>${entry.hour}:00</td><td>${entry.cajas}</td><td>${entry.coordinatorId}</td><td>${new Date(entry.timestamp).toLocaleString()}</td><td>${entry.isLate ? 'S√≠' : 'No'}</td></tr>`);
                });
            });

            rows.push('</tbody></table>');

            container.innerHTML = rows.length > 2 ? rows.join('') : 'No hay registros';
        }

        function updateAdminExtrasTable(date) {
            const today = date || document.getElementById('export-date').value || new Date().toISOString().split('T')[0];
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            const shifts = allShifts[today] || {};
            const container = document.getElementById('admin-extras-table');
            const rows = [];
            rows.push('<table class="data-table"><thead><tr><th>Cuadrilla</th><th>Nombre/ID</th><th>Rol</th><th>Horas</th><th>Hora</th><th>Coordinador</th><th>Fecha Registro</th></tr></thead><tbody>');

            let any = false;
            Object.keys(shifts).forEach(cuadrilla => {
                const shift = shifts[cuadrilla];
                if (shift && shift.extras && Array.isArray(shift.extras)) {
                        shift.extras.forEach(extra => {
                            const roleNames = {montacarguistas:'Montacarguistas', almacenistas:'Almacenistas', auditores:'Auditores', auxiliares:'Auxiliares', analistas:'Analistas', otro:'Otro'};
                        any = true;
                        const coord = shift.coordinatorId || '';
                        rows.push(`<tr><td>${cuadrilla === 'mixto' ? 'Turno Mixto' : (SYSTEM_CONFIG.cuadrillas[cuadrilla] ? SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre : cuadrilla)}</td><td>${extra.name || '-'}</td><td>${roleNames[extra.role] || extra.role}</td><td>${extra.hours}</td><td>${extra.hora || '-'}</td><td>${coord}</td><td>${new Date(shift.timestamp).toLocaleString()}</td></tr>`);
                    });
                }
            });

            rows.push('</tbody></table>');
            container.innerHTML = any ? rows.join('') : 'No hay personal extra registrado';
        }

        function updateAdminCuadrillaDetails(date) {
            const today = date || document.getElementById('export-date').value || new Date().toISOString().split('T')[0];
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            const container = document.getElementById('admin-cuadrilla-details');
            const rows = [];
            rows.push('<table class="data-table"><thead><tr><th>Cuadrilla</th><th>Turno</th><th>Cajas</th><th>Meta</th><th>% Cumplimiento</th><th>Estado</th></tr></thead><tbody>');

            const cuadrillas = Object.keys(SYSTEM_CONFIG.cuadrillas).concat(['mixto']);
            let any = false;
            cuadrillas.forEach(cuadrilla => {
                const entries = (allHourly[today] || {})[cuadrilla] || [];
                const totalCajas = entries.reduce((sum, e) => sum + (e.cajas || 0), 0);
                let turno = cuadrilla === 'mixto' ? 'mixto' : getCurrentTurnoForCuadrilla(cuadrilla);
                let turnoDisplay = turno === 'mixto' ? 'Mixto' : `Turno ${turno}`;
                const shiftData = (allShifts[today] || {})[cuadrilla];
                let meta = 0;
                if (cuadrilla === 'mixto') {
                    meta = (shiftData && shiftData.metaTurno) ? shiftData.metaTurno : SYSTEM_CONFIG.turnos['mixto'].metaBase;
                } else {
                    meta = (shiftData && shiftData.metaTurno) ? shiftData.metaTurno : (SYSTEM_CONFIG.turnos[turno] ? SYSTEM_CONFIG.turnos[turno].metaBase : 0);
                }
                const porcentaje = meta > 0 ? (totalCajas / meta) * 100 : 0;
                const statusHtml = getMetaStatusHTML(totalCajas, meta);
                const name = cuadrilla === 'mixto' ? 'Mixto' : (SYSTEM_CONFIG.cuadrillas[cuadrilla] ? SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre : cuadrilla);
                rows.push(`<tr><td>${name}</td><td>${turnoDisplay}</td><td>${totalCajas}</td><td>${meta || '-'}</td><td>${porcentaje.toFixed(1)}%</td><td>${statusHtml}</td></tr>`);
                any = true;
            });

            rows.push('</tbody></table>');
            container.innerHTML = any ? rows.join('') : 'No hay datos';
        }

        // Detect turnos that have missing hours or late entries for the admin alert
        function detectTardyTurnos(date) {
            const today = date || new Date().toISOString().split('T')[0];
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            const now = new Date();
            const currentHour = now.getHours();
            const yesterdayKey = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            const allHourlyToday = allHourly[today] || {};
            const allHourlyYesterday = allHourly[yesterdayKey] || {};

            function isHourInPast(hour) {
                if (currentHour >= 6) {
                    return hour >= 6 && hour <= currentHour;
                }
                return (hour >= 0 && hour <= currentHour) || (hour >= 22 && hour <= 23);
            }

            const tardyMap = {};

            const cuadrillas = Object.keys(SYSTEM_CONFIG.cuadrillas).concat('mixto');
            cuadrillas.forEach(cuadrilla => {
                const turno = getCurrentTurnoForCuadrilla(cuadrilla);
                if (!tardyMap[turno]) tardyMap[turno] = { name: turno === 'mixto' ? 'Mixto' : `Turno ${turno}`, lateCount: 0, missingCount: 0, cuadrillas: new Set() };
                // Count late entries
                const entries = (allHourlyToday[cuadrilla] || []).concat(allHourlyYesterday[cuadrilla] || []);

                // If there is neither a shift record nor any hourly entries for this cuadrilla, skip (no data -> no missing alerts)
                const shiftExists = !!(allShifts[today] && allShifts[today][cuadrilla]);
                const hadHourlyToday = (allHourlyToday[cuadrilla] || []).length > 0;
                const hadHourlyYesterday = (allHourlyYesterday[cuadrilla] || []).length > 0;
                if (!shiftExists && !hadHourlyToday && !hadHourlyYesterday) {
                    return; // continue to next cuadrilla
                }

                // If the shift exists but was started less than 1 hour ago, don't consider it missing yet (allow time before first hourly report)
                let shouldCheckMissing = true;
                try {
                    if (shiftExists) {
                        const shift = allShifts[today][cuadrilla];
                        if (shift && shift.timestamp) {
                            const shiftStartMs = new Date(shift.timestamp).getTime();
                            const nowMs = new Date().getTime();
                            if ((nowMs - shiftStartMs) < (60 * 60 * 1000)) {
                                shouldCheckMissing = false;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Error computing shift start time for missing check', e);
                }
                const late = entries.filter(e => e.isLate === true).length;
                if (late > 0) {
                    tardyMap[turno].lateCount += late;
                    tardyMap[turno].cuadrillas.add(cuadrilla);
                }

                // Check missing hours for this cuadrilla and its turno
                const turnoConfig = SYSTEM_CONFIG.turnos[turno] || { horas: [] };
                (turnoConfig.horas || []).forEach(h => {
                    if (!isHourInPast(h)) return; // only check past hours
                    const hourStr = h.toString().padStart(2, '0');
                    // If now < 6 and hour >= 22, check yesterday
                    const hasEntry = (currentHour < 6 && h >= 22) ? (allHourlyYesterday[cuadrilla] || []).some(e => e.hour === hourStr) : (allHourlyToday[cuadrilla] || []).some(e => e.hour === hourStr);
                    if (!shouldCheckMissing) return; // skip if recently started
                    if (!hasEntry) {
                        tardyMap[turno].missingCount += 1;
                        tardyMap[turno].cuadrillas.add(cuadrilla);
                    }
                });
            });

            // Convert to array and filter those with issues
            const tardyList = Object.keys(tardyMap).map(k => ({ turno: k, name: tardyMap[k].name, lateCount: tardyMap[k].lateCount, missingCount: tardyMap[k].missingCount, cuadrillas: Array.from(tardyMap[k].cuadrillas) })).filter(t => t.lateCount > 0 || t.missingCount > 0);
            return tardyList;
        }

        function updateAdminTardyList(date) {
            if (userType !== 'admin') return; // only admins should see tardy turnos
            const today = date || document.getElementById('export-date').value || new Date().toISOString().split('T')[0];
            const tardy = detectTardyTurnos(today);
            const container = document.getElementById('admin-alerts');
            if (!container) return;
            // Remove previous details if any
            const detailsExisting = container.querySelector('.tardy-details');
            if (detailsExisting) detailsExisting.remove();

            if (!tardy || tardy.length === 0) {
                const el = document.createElement('div');
                el.className = 'tardy-details';
                el.textContent = 'No se detectaron turnos con registros tard√≠os.';
                container.appendChild(el);
                return;
            }

            const el = document.createElement('div');
            el.className = 'tardy-details';
            const rows = [];
            rows.push('<table class="data-table"><thead><tr><th>Turno</th><th>Cuadrillas afectadas</th><th>Tard√≠os</th><th>Faltantes</th></tr></thead><tbody>');
            tardy.forEach(t => {
                rows.push(`<tr><td>${t.name}</td><td>${t.cuadrillas.map(c => c === 'mixto' ? 'Mixto' : (SYSTEM_CONFIG.cuadrillas[c] ? SYSTEM_CONFIG.cuadrillas[c].nombre : c)).join(', ')}</td><td>${t.lateCount}</td><td>${t.missingCount}</td></tr>`);
            });
            rows.push('</tbody></table>');
            el.innerHTML = rows.join('');
            container.appendChild(el);
        }

        function updateAdminMissingProfiles(date) {
            if (userType !== 'admin') return; // only admins should show these alerts
            const today = date || document.getElementById('export-date').value || new Date().toISOString().split('T')[0];
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            const container = document.getElementById('admin-alerts');
            if (!container) return;

            // Build a set of coordinators who have recorded shift or hourly data
            const recordedCoordinators = new Set();
            if (allShifts[today]) {
                Object.values(allShifts[today]).forEach(s => {
                    if (s && s.coordinatorId) recordedCoordinators.add(s.coordinatorId);
                });
            }
            if (allHourly[today]) {
                Object.values(allHourly[today]).forEach(arr => {
                    arr.forEach(e => { if (e.coordinatorId) recordedCoordinators.add(e.coordinatorId); });
                });
            }

            // Collect all configured coordinator IDs from SYSTEM_CONFIG
            const configuredCoordinators = [];
            Object.keys(SYSTEM_CONFIG.coordinadores || {}).forEach(cuadrilla => {
                SYSTEM_CONFIG.coordinadores[cuadrilla].forEach(id => {
                    configuredCoordinators.push({ id, cuadrilla });
                });
            });

            // Find missing ones (only if their turno should have started already)
            const dismissedProfiles = JSON.parse(localStorage.getItem('dismissedProfileAlerts') || '{}');
            const dismissedForToday = dismissedProfiles[today] || [];
            const now = new Date();
            const currentHour = now.getHours();
            const missing = configuredCoordinators.filter(c => {
                if (dismissedForToday.includes(c.id)) return false;
                if (recordedCoordinators.has(c.id)) return false; // they already registered
                // Determine turno for this cuadrilla
                const turno = getCurrentTurnoForCuadrilla(c.cuadrilla);
                const turnoCfg = SYSTEM_CONFIG.turnos[turno];
                if (!turnoCfg) return true; // if unknown, consider missing
                // Check if the turno has started (respecting overnight hours)
                const start = turnoCfg.inicio;
                const end = turnoCfg.fin;
                let hasStarted = false;
                if (start <= end) {
                    // normal day
                    if (currentHour >= start) hasStarted = true;
                } else {
                    // overnight (e.g., start 22, end 5)
                    if (currentHour >= start || currentHour <= end) hasStarted = true;
                }
                // Only mark missing if the turno has started (i.e., 'hasta ahora' deber√≠a haber registrado)
                return hasStarted;
            });

            // Remove previous 'missing-profiles' if any
            const prev = container.querySelector('.missing-profiles');
            if (prev) prev.remove();

            const el = document.createElement('div');
            el.className = 'missing-profiles';
            if (!missing || missing.length === 0) {
                el.innerHTML = '<div class="success-banner">No hay coordinadores sin registros para la fecha seleccionada</div>';
                container.appendChild(el);
                return;
            }

            const rows = [];
            rows.push('<table class="data-table"><thead><tr><th>ID Coordinador</th><th>Cuadrilla</th><th>Acciones</th></tr></thead><tbody>');
            missing.forEach(m => {
                const name = m.cuadrilla === 'mixto' ? 'Mixto' : (SYSTEM_CONFIG.cuadrillas && SYSTEM_CONFIG.cuadrillas[m.cuadrilla] ? SYSTEM_CONFIG.cuadrillas[m.cuadrilla].nombre : m.cuadrilla);
                rows.push(`<tr><td>${m.id}</td><td>${name}</td><td><button class="remind-btn" data-id="${m.id}">üì£ Recordar</button> <button class="dismiss-profile" data-id="${m.id}">‚úñÔ∏è Descartar</button></td></tr>`);
            });
            rows.push('</tbody></table>');
            el.innerHTML = rows.join('');
            container.appendChild(el);

            // Attach event listeners to remind buttons (just simulate alert now)
            el.querySelectorAll('.remind-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    alert(`Se envi√≥ un recordatorio al coordinador ${id} (simulado)`);
                });
            });

            // Add dismiss action to remember removals
            el.querySelectorAll('.dismiss-profile').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const dismissedProfiles = JSON.parse(localStorage.getItem('dismissedProfileAlerts') || '{}');
                    if (!dismissedProfiles[today]) dismissedProfiles[today] = [];
                    dismissedProfiles[today].push(id);
                    localStorage.setItem('dismissedProfileAlerts', JSON.stringify(dismissedProfiles));
                    updateAdminMissingProfiles(today);
                });
            });
        }
        
        function checkAdminAlerts() {
                    const alertsContainer = document.getElementById('admin-alerts');
                    // S√≥lo ejecutar l√≥gica de alertas si el usuario es administrador
                    if (userType !== 'admin') {
                        if (alertsContainer) {
                            alertsContainer.style.display = 'none';
                            alertsContainer.innerHTML = '';
                        }
                        return;
                    }
            alertsContainer.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            const now = new Date();
            const currentHour = now.getHours();
            // Determinar horas esperadas (uni√≥n de todas las horas definidas por turnos)
            const expectedHoursSet = new Set();
            Object.values(SYSTEM_CONFIG.turnos).forEach(t => {
                (t.horas || []).forEach(h => expectedHoursSet.add(h));
            });

            const expectedHours = Array.from(expectedHoursSet).sort((a,b) => a - b);

            // Fecha de ayer para turnos que comenzaron antes de la medianoche
            const yesterdayKey = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            const allHourlyToday = allHourly[today] || {};
            const allHourlyYesterday = allHourly[yesterdayKey] || {};

            function isHourInPast(hour) {
                // Si la hora actual es >= 6: esperamos registros desde las 06:00 hasta currentHour
                if (currentHour >= 6) {
                    return hour >= 6 && hour <= currentHour;
                }
                // Si la hora actual es < 6: esperamos registros desde 00:00 hasta currentHour (hoy)
                // y tambi√©n horas 22 y 23 del d√≠a anterior (overnight)
                return (hour >= 0 && hour <= currentHour) || (hour >= 22 && hour <= 23);
            }

            function hasHourData(hour) {
                const hourStr = hour.toString().padStart(2, '0');
                // Determinar si la hora esperada corresponde a hoy o a ayer (22,23 antes de medianoche)
                if (currentHour < 6 && hour >= 22) {
                    // Revisar en registros de ayer
                    return Object.values(allHourlyYesterday).some(cuadrillaData => cuadrillaData.some(entry => entry.hour === hourStr));
                }
                // Si no, revisar en registros de hoy
                return Object.values(allHourlyToday).some(cuadrillaData => cuadrillaData.some(entry => entry.hour === hourStr));
            }

            // Verificar horas sin registro (solo las horas que ya deber√≠an estar registradas)
            expectedHours.forEach(hour => {
                if (!isHourInPast(hour)) return; // a√∫n no esperamos registro para horas futuras

                const hourStr = hour.toString().padStart(2, '0');
                // No mostrar alertas descartadas
                const dismissedAlerts = JSON.parse(localStorage.getItem('dismissedAlerts') || '{}');
                const dismissedForToday = dismissedAlerts[today] || [];
                if (dismissedForToday.includes(hourStr)) return;

                if (!hasHourData(hour)) {
                    const alert = document.createElement('div');
                    alert.className = 'alert-banner';
                    alert.innerHTML = `‚ö†Ô∏è Alerta: No se registr√≥ total cajas para las ${hourStr}:00 
                        <button class="dismiss-alert" data-hour="${hourStr}">X</button>`;
                    alertsContainer.appendChild(alert);
                }
            });
            
            // Agregar evento para eliminar alertas
            document.querySelectorAll('.dismiss-alert').forEach(button => {
                button.addEventListener('click', function() {
                    const hour = this.getAttribute('data-hour');
                    this.parentElement.remove();
                    
                    // Guardar que esta alerta fue descartada
                    const dismissedAlerts = JSON.parse(localStorage.getItem('dismissedAlerts') || '{}');
                    if (!dismissedAlerts[today]) dismissedAlerts[today] = [];
                    dismissedAlerts[today].push(hour);
                    localStorage.setItem('dismissedAlerts', JSON.stringify(dismissedAlerts));
                });
            });
            
            if (alertsContainer.children.length > 0) {
                alertsContainer.style.display = 'block';
            }

            // Additionally detect tardy turnos and add a compact alert with details toggle
            try {
                const tardyList = detectTardyTurnos();
                // remove any existing tardy alert to avoid duplicates
                const existing = alertsContainer.querySelector('.tardy-turnos-alert');
                if (existing) existing.remove();

                if (tardyList && tardyList.length > 0) {
                    const tardyEl = document.createElement('div');
                    tardyEl.className = 'alert-banner tardy-turnos-alert';
                    // No listar los nombres en el encabezado para mantenerlo compacto
                    tardyEl.innerHTML = `‚ö†Ô∏è Turnos con registros tard√≠os ` +
                        `<button class="show-tardy-details">Ver detalles</button>`;
                    alertsContainer.appendChild(tardyEl);
                    alertsContainer.style.display = 'block';

                    // Attach event: toggle show/hide details
                    tardyEl.querySelector('.show-tardy-details').addEventListener('click', function() {
                        const details = alertsContainer.querySelector('.tardy-details');
                        const btn = this;
                        if (details) {
                            details.remove();
                            btn.textContent = 'Ver detalles';
                        } else {
                            updateAdminTardyList();
                            btn.textContent = 'Ocultar detalles';
                        }
                    });
                }
            } catch (e) {
                console.error('Error while checking tardy turnos', e);
            }

            // After usual alerts are added, always show missing profiles
            updateAdminMissingProfiles();

            // Also list missing coordinator profiles as alerts (or 'missing profiles')
            updateAdminMissingProfiles(today);
        }

        // Devuelve los turnos que deber√≠an estar activos en la hora actual
        // Active/tardy turno functions removed per user's request to keep admin dashboard concise
        
        function setupAdminLiveToggle() {
            const toggle = document.getElementById('admin-live-toggle');
            const exportDateInput = document.getElementById('export-date');
            const liveBadge = document.getElementById('admin-live-badge');
            // Initialize from localStorage
            try {
                const live = localStorage.getItem('adminLive') === 'true';
                toggle.checked = live;
                if (live) {
                    // Force export date to today when live is on
                    exportDateInput.value = new Date().toISOString().split('T')[0];
                    if (adminLiveInterval) clearInterval(adminLiveInterval);
                    updateAdminDashboard();
                    updateAdminHourlyTable();
                    adminLiveInterval = setInterval(() => {
                        updateAdminDashboard();
                        updateAdminHourlyTable();
                        updateAdminMissingProfiles();
                    }, 60000);
                    if (liveBadge) liveBadge.style.display = 'inline-block';
                }

                toggle.addEventListener('change', function() {
                    const live = this.checked;
                    localStorage.setItem('adminLive', live ? 'true' : 'false');
                    if (live) {
                        // Enable live updates: force the date to today and start live Firestore listeners if possible.
                        exportDateInput.value = new Date().toISOString().split('T')[0];
                        if (window.firebaseInitialized && window.db) {
                            // Fast path: use Firestore onSnapshot listeners
                            startLiveFirestoreListeners();
                            updateAdminDashboard();
                            updateAdminHourlyTable();
                        } else {
                            // fallback to polling every 60s
                            if (adminLiveInterval) clearInterval(adminLiveInterval);
                            updateAdminDashboard();
                            updateAdminHourlyTable();
                            adminLiveInterval = setInterval(() => {
                                updateAdminDashboard();
                                updateAdminHourlyTable();
                                updateAdminMissingProfiles();
                            }, 60000);
                        }
                        if (liveBadge) liveBadge.style.display = 'inline-block';
                    } else {
                        // Disable live updates
                        if (window.firebaseInitialized && window.db) {
                            stopLiveFirestoreListeners();
                        }
                        if (adminLiveInterval) {
                            clearInterval(adminLiveInterval);
                            adminLiveInterval = null;
                        }
                        const selected = exportDateInput.value || new Date().toISOString().split('T')[0];
                        updateAdminDashboard(selected);
                        updateAdminHourlyTable(selected);
                        // also check missing profiles when toggling
                        updateAdminMissingProfiles(selected);
                        if (liveBadge) liveBadge.style.display = 'none';
                    }
                });
            } catch (e) {
                console.error('Error initializing admin live toggle', e);
            }
        }
        
        function setupExportButtons() {
            document.getElementById('export-daily-excel').addEventListener('click', exportDailyExcel);
            document.getElementById('export-backup').addEventListener('click', exportBackup);
            const appendAggregatedToggle = document.getElementById('append-aggregated-export');
            const exportAggregatedBtn = document.getElementById('export-aggregated-excel');
            const clearAggregatedBtn = document.getElementById('clear-aggregated-export');
            if (exportAggregatedBtn) exportAggregatedBtn.addEventListener('click', exportAggregatedExcel);
            if (clearAggregatedBtn) clearAggregatedBtn.addEventListener('click', clearAggregatedExport);
            document.getElementById('export-date').addEventListener('change', function() {
                const selected = this.value;
                updateDataPreview();
                // Only update admin dashboard/table for historical view when Live is OFF
                const live = localStorage.getItem('adminLive') === 'true';
                if (!live) {
                    updateAdminDashboard(selected);
                    updateAdminHourlyTable(selected);
                }
            });
            // Demo loading feature removed.
            const clearBtn = document.getElementById('clear-local-data');
            if (clearBtn) clearBtn.addEventListener('click', function() {
                if (confirm('¬øDesea eliminar todos los datos locales (shifts, hourly y alertas)?')) {
                    localStorage.removeItem('shiftData');
                    localStorage.removeItem('hourlyData');
                    localStorage.removeItem('dismissedAlerts');
                    localStorage.removeItem('lastExport');
                    updateDataPreview();
                    updateAdminDashboard();
                    updateProgressView();
                    alert('Datos locales eliminados. La vista ahora est√° limpia.');
                }
            });
            // Cuando el admin cambia la fecha, actualizar tabla de registros (si Live est√° OFF)
            // NOTE: consolidated with previous export-date change handler above.
        }

        // Controls for active turno highlighting and filtering in Admin
        function setupAdminActiveControls() {
            const highlightToggle = document.getElementById('admin-highlight-active-toggle');
            const filterToggle = document.getElementById('admin-filter-active-toggle');
            // default: highlight on
            if (highlightToggle) highlightToggle.checked = true;
            if (filterToggle) filterToggle.checked = false;

            // Attach event listeners
            if (highlightToggle) highlightToggle.addEventListener('change', () => updateAdminDashboard());
            if (filterToggle) filterToggle.addEventListener('change', () => updateAdminDashboard());
        }

        function getActiveTurnoKey() {
            const now = new Date();
            const hour = now.getHours();
            for (const key in SYSTEM_CONFIG.turnos) {
                const t = SYSTEM_CONFIG.turnos[key];
                if (!t || !Array.isArray(t.horas)) continue;
                if (t.horas.includes(hour)) return key;
            }
            return null;
        }

        // Demo loader function removed per user request
        
        function updateDataPreview() {
            const date = document.getElementById('export-date').value;
            const preview = document.getElementById('data-preview-content');
            
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            
            const shiftData = allShifts[date] || {};
            const hourlyData = allHourly[date] || {};
            
            let html = '<table class="data-table"><tr><th>Cuadrilla</th><th>Turno</th><th>Asistencia</th><th>Cajas Total</th><th>Horas Registradas</th><th>Registros Tard√≠os</th><th>Personal Extra</th><th>Comentarios</th></tr>';
            
            const cuadrillaKeys = Object.keys(SYSTEM_CONFIG.cuadrillas).concat('mixto');
            cuadrillaKeys.forEach(cuadrilla => {
                const cuadrillaShifts = shiftData[cuadrilla];
                const cuadrillaHourly = hourlyData[cuadrilla] || [];
                const cuadrillaNombre = cuadrilla === 'mixto' ? 'Turno Mixto' : SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre;
                
                // Obtener turno actual de esta cuadrilla
                const turno = getCurrentTurnoForCuadrilla(cuadrilla);
                
                const asistencia = cuadrillaShifts ? 
                    `M:${cuadrillaShifts.attendance.montas} Al:${cuadrillaShifts.attendance.alm} Au:${cuadrillaShifts.attendance.auditores} A:${cuadrillaShifts.attendance.auxiliares}` + 
                    (cuadrillaShifts.attendance.analistas ? ` An:${cuadrillaShifts.attendance.analistas}` : '') : 
                    'No registrado';
                
                const totalCajas = cuadrillaHourly.reduce((sum, entry) => sum + entry.cajas, 0);
                const horasRegistradas = cuadrillaHourly.length;
                const registrosTardios = cuadrillaHourly.filter(entry => entry.isLate).length;
                const comentarios = cuadrillaShifts && cuadrillaShifts.comentarios ? cuadrillaShifts.comentarios : 'Ninguno';
                
                const extrasCount = cuadrillaShifts && cuadrillaShifts.extras ? (cuadrillaShifts.extras.length) : 0;
                const extrasHours = cuadrillaShifts && cuadrillaShifts.extras ? cuadrillaShifts.extras.reduce((s,e)=> s + parseFloat(e.hours||0),0) : 0;
                html += `<tr>
                    <td>${cuadrillaNombre}</td>
                    <td>${turno}</td>
                    <td>${asistencia}</td>
                    <td>${totalCajas}</td>
                    <td>${horasRegistradas}</td>
                    <td>${registrosTardios}</td>
                    <td>${extrasCount} (${extrasHours}h)</td>
                    <td>${comentarios}</td>
                </tr>`;
            });
            
            html += '</table>';
            preview.innerHTML = html;
        }
        
        function exportDailyExcel() {
            const date = document.getElementById('export-date').value;
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            
            const shiftData = allShifts[date] || {};
            const hourlyData = allHourly[date] || {};
            
            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            
            // Hoja de resumen
            const summaryData = [
                ['REPORTE DIARIO - SISTEMA GESTOR'],
                ['Fecha:', date],
                [''],
                ['RESUMEN POR CUADRILLA'],
                ['Cuadrilla', 'Turno', 'Asistencia Montas', 'Asistencia Alm', 'Asistencia Auditores', 'Asistencia Auxiliares', 'Asistencia Analistas', 'Cajas Total', 'Horas Registradas', 'Registros Tard√≠os', 'Personal Extra', 'Horas Extra', 'Comentarios', 'Meta Ajustada']
            ];
            
            Object.keys(SYSTEM_CONFIG.cuadrillas).concat('mixto').forEach(cuadrilla => {
                const cuadrillaShifts = shiftData[cuadrilla];
                const cuadrillaHourly = hourlyData[cuadrilla] || [];
                const turno = getCurrentTurnoForCuadrilla(cuadrilla);
                
                const totalCajas = cuadrillaHourly.reduce((sum, entry) => sum + entry.cajas, 0);
                const registrosTardios = cuadrillaHourly.filter(entry => entry.isLate).length;
                const comentarios = cuadrillaShifts && cuadrillaShifts.comentarios ? cuadrillaShifts.comentarios : 'Ninguno';
                const metaAjustada = cuadrillaShifts && cuadrillaShifts.metaTurno ? cuadrillaShifts.metaTurno : 'No registrada';
                
                const summaryNombre = cuadrilla === 'mixto' ? 'Turno Mixto' : SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre;
                const extrasCount = (cuadrillaShifts && cuadrillaShifts.extras) ? cuadrillaShifts.extras.length : 0;
                const extrasHours = (cuadrillaShifts && cuadrillaShifts.extras) ? cuadrillaShifts.extras.reduce((s,e)=> s + parseFloat(e.hours||0), 0) : 0;
                summaryData.push([
                    summaryNombre,
                    turno,
                    cuadrillaShifts ? cuadrillaShifts.attendance.montas : 'No registrado',
                    cuadrillaShifts ? cuadrillaShifts.attendance.alm : 'No registrado',
                    cuadrillaShifts ? cuadrillaShifts.attendance.auditores : 'No registrado',
                    cuadrillaShifts ? cuadrillaShifts.attendance.auxiliares : 'No registrado',
                    cuadrillaShifts && cuadrillaShifts.attendance.analistas ? cuadrillaShifts.attendance.analistas : 'N/A',
                    totalCajas,
                    cuadrillaHourly.length,
                    registrosTardios,
                    extrasCount,
                    extrasHours,
                    comentarios,
                    metaAjustada
                ]);
            });
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Resumen');
            
            // Hoja de datos detallados por cuadrilla
            Object.keys(SYSTEM_CONFIG.cuadrillas).concat('mixto').forEach(cuadrilla => {
                const cuadrillaHourly = hourlyData[cuadrilla] || [];
                const cuadrillaShifts = shiftData[cuadrilla];
                const turno = getCurrentTurnoForCuadrilla(cuadrilla);
                
                const sheetName = cuadrilla === 'mixto' ? 'Turno Mixto' : SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre;
                const cuadrillaData = [
                    [`DETALLES ${sheetName.toUpperCase()} - TURNO ${turno}`],
                    ['Hora', 'Cajas', 'Coordinador', 'Timestamp', 'Registro Tard√≠o']
                ];
                
                cuadrillaHourly.forEach(entry => {
                    cuadrillaData.push([
                        `${entry.hour}:00`,
                        entry.cajas,
                        entry.coordinatorId,
                        new Date(entry.timestamp).toLocaleString(),
                        entry.isLate ? 'S√≠' : 'No'
                    ]);
                });
                
                if (cuadrillaShifts) {
                    cuadrillaData.push(['']);
                    cuadrillaData.push(['ASISTENCIA INICIAL']);
                    cuadrillaData.push(['Montacarguistas:', cuadrillaShifts.attendance.montas]);
                    cuadrillaData.push(['Almacenistas:', cuadrillaShifts.attendance.alm]);
                    cuadrillaData.push(['Auditores:', cuadrillaShifts.attendance.auditores]);
                    cuadrillaData.push(['Auxiliares:', cuadrillaShifts.attendance.auxiliares]);
                    if (cuadrillaShifts.attendance.analistas) {
                        cuadrillaData.push(['Analistas:', cuadrillaShifts.attendance.analistas]);
                    }
                    cuadrillaData.push(['Coordinador:', cuadrillaShifts.coordinatorId]);
                    cuadrillaData.push(['Turno:', turno]);
                    cuadrillaData.push(['Meta Ajustada:', cuadrillaShifts.metaTurno]);
                    const extrasList = cuadrillaShifts.extras || [];
                    if (extrasList.length) {
                        cuadrillaData.push(['']);
                        cuadrillaData.push(['PERSONAL EXTRA']);
                        cuadrillaData.push(['Nombre/ID', 'Rol', 'Horas']);
                        extrasList.forEach(ex => {
                            cuadrillaData.push([ex.name || '-', ex.role, ex.hours]);
                        });
                    }
                    cuadrillaData.push(['Comentarios:', cuadrillaShifts.comentarios]);
                    cuadrillaData.push(['Timestamp:', new Date(cuadrillaShifts.timestamp).toLocaleString()]);
                }
                
                const ws = XLSX.utils.aoa_to_sheet(cuadrillaData);
                XLSX.utils.book_append_sheet(wb, ws, `${sheetName}`);
            });
            
            // Exportar
            const fileName = `reporte_diario_${date}.xlsx`;
            XLSX.writeFile(wb, fileName);
            if (document.getElementById('append-aggregated-export') && document.getElementById('append-aggregated-export').checked) {
                appendToAggregatedExport(date);
            }
            updateLastExportInfo();
        }
        
        function exportBackup() {
            // Export a single Excel workbook that contains:
            // - All shifts (All_Shifts)
            // - All hourly entries (All_Hourly)
            // - A 'Resumen' sheet for the selected date (if any)
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            const selectedDate = document.getElementById('export-date').value || new Date().toISOString().split('T')[0];

            const wb = XLSX.utils.book_new();

            // All Shifts - flattened
            const shiftsSheet = [];
            shiftsSheet.push(['Fecha', 'Cuadrilla', 'Coordinador', 'Turno', 'Montas', 'Almacenistas', 'Auditores', 'Auxiliares', 'Analistas', 'MetaTurno', 'Extras (JSON)', 'Total Horas Extras', 'Comentarios', 'Timestamp']);
            Object.keys(allShifts).forEach(date => {
                const shiftsOnDate = allShifts[date] || {};
                Object.keys(shiftsOnDate).forEach(cuadrilla => {
                    const shift = shiftsOnDate[cuadrilla];
                    if (!shift) return;
                    const extrasJson = JSON.stringify(shift.extras || []);
                    const extrasSum = (shift.extras || []).reduce((s, e) => s + parseFloat(e.hours || 0), 0);
                    shiftsSheet.push([
                        date,
                        cuadrilla === 'mixto' ? 'Turno Mixto' : (SYSTEM_CONFIG.cuadrillas[cuadrilla] ? SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre : cuadrilla),
                        shift.coordinatorId || '',
                        shift.turno || getCurrentTurnoForCuadrilla(cuadrilla),
                        shift.attendance ? shift.attendance.montas : '',
                        shift.attendance ? shift.attendance.alm : '',
                        shift.attendance ? shift.attendance.auditores : '',
                        shift.attendance ? shift.attendance.auxiliares : '',
                        shift.attendance && shift.attendance.analistas ? shift.attendance.analistas : '',
                        shift.metaTurno || '',
                        extrasJson,
                        extrasSum,
                        shift.comentarios || '',
                        shift.timestamp || ''
                    ]);
                });
            });
            const wsShifts = XLSX.utils.aoa_to_sheet(shiftsSheet);
            XLSX.utils.book_append_sheet(wb, wsShifts, 'All_Shifts');

            // All Hourly entries - flattened
            const hourlySheet = [];
            hourlySheet.push(['Fecha', 'Cuadrilla', 'Hora', 'Cajas', 'Coordinador', 'Timestamp', 'Tard√≠o']);
            Object.keys(allHourly).forEach(date => {
                const hourlyOnDate = allHourly[date] || {};
                Object.keys(hourlyOnDate).forEach(cuadrilla => {
                    const entries = hourlyOnDate[cuadrilla] || [];
                    entries.forEach(entry => {
                        hourlySheet.push([
                            date,
                            cuadrilla === 'mixto' ? 'Turno Mixto' : (SYSTEM_CONFIG.cuadrillas[cuadrilla] ? SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre : cuadrilla),
                            `${entry.hour}:00`,
                            entry.cajas,
                            entry.coordinatorId,
                            entry.timestamp || '',
                            entry.isLate ? 'S√≠' : 'No'
                        ]);
                    });
                });
            });
            const wsHourly = XLSX.utils.aoa_to_sheet(hourlySheet);
            XLSX.utils.book_append_sheet(wb, wsHourly, 'All_Hourly');

            // Add a 'Resumen' sheet for selected date (reusing exportDailyExcel structure)
            const date = selectedDate;
            const shiftData = JSON.parse(localStorage.getItem('shiftData') || '{}')[date] || {};
            const hourlyData = JSON.parse(localStorage.getItem('hourlyData') || '{}')[date] || {};
            const summaryData = [
                ['REPORTE DIARIO - SISTEMA GESTOR'],
                ['Fecha:', date],
                [''],
                ['RESUMEN POR CUADRILLA'],
                ['Cuadrilla', 'Turno', 'Asistencia Montas', 'Asistencia Alm', 'Asistencia Auditores', 'Asistencia Auxiliares', 'Asistencia Analistas', 'Cajas Total', 'Horas Registradas', 'Registros Tard√≠os', 'Personal Extra', 'Horas Extra', 'Comentarios', 'Meta Ajustada']
            ];
            Object.keys(SYSTEM_CONFIG.cuadrillas).concat('mixto').forEach(cuadrilla => {
                const cuadrillaShifts = shiftData[cuadrilla];
                const cuadrillaHourly = hourlyData[cuadrilla] || [];
                const turno = getCurrentTurnoForCuadrilla(cuadrilla);
                const totalCajas = cuadrillaHourly.reduce((sum, entry) => sum + entry.cajas, 0);
                const registrosTardios = cuadrillaHourly.filter(entry => entry.isLate).length;
                const comentarios = cuadrillaShifts && cuadrillaShifts.comentarios ? cuadrillaShifts.comentarios : 'Ninguno';
                const metaAjustada = cuadrillaShifts && cuadrillaShifts.metaTurno ? cuadrillaShifts.metaTurno : 'No registrada';
                const summaryNombre = cuadrilla === 'mixto' ? 'Turno Mixto' : SYSTEM_CONFIG.cuadrillas[cuadrilla].nombre;
                const extrasCount = (cuadrillaShifts && cuadrillaShifts.extras) ? cuadrillaShifts.extras.length : 0;
                const extrasHours = (cuadrillaShifts && cuadrillaShifts.extras) ? cuadrillaShifts.extras.reduce((s,e)=> s + parseFloat(e.hours||0), 0) : 0;
                summaryData.push([
                    summaryNombre,
                    turno,
                    cuadrillaShifts ? cuadrillaShifts.attendance.montas : 'No registrado',
                    cuadrillaShifts ? cuadrillaShifts.attendance.alm : 'No registrado',
                    cuadrillaShifts ? cuadrillaShifts.attendance.auditores : 'No registrado',
                    cuadrillaShifts ? cuadrillaShifts.attendance.auxiliares : 'No registrado',
                    cuadrillaShifts && cuadrillaShifts.attendance.analistas ? cuadrillaShifts.attendance.analistas : 'N/A',
                    totalCajas,
                    cuadrillaHourly.length,
                    registrosTardios,
                    extrasCount,
                    extrasHours,
                    comentarios,
                    metaAjustada
                ]);
            });
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumen');

            const fileName = `export_completo_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            if (document.getElementById('append-aggregated-export') && document.getElementById('append-aggregated-export').checked) {
                // Append all dates available
                Object.keys(allShifts).forEach(dateKey => {
                    appendToAggregatedExport(dateKey);
                });
            }

            updateLastExportInfo();
        }
        
        function updateLastExportInfo() {
            const lastExport = localStorage.getItem('lastExport');
            const infoElement = document.getElementById('last-export-info');
            
            if (lastExport) {
                infoElement.textContent = `√öltima exportaci√≥n: ${new Date(lastExport).toLocaleString()}`;
            } else {
                infoElement.textContent = '√öltima exportaci√≥n: Nunca';
            }
            
            localStorage.setItem('lastExport', new Date().toISOString());
        }

        // Aggregated export helpers
        function getAggregatedStore(){
            return JSON.parse(localStorage.getItem('aggregatedExport') || JSON.stringify({shifts:[], hourly:[], lastUpdated: null}));
        }
        function setAggregatedStore(store){
            localStorage.setItem('aggregatedExport', JSON.stringify(store));
        }

        function appendToAggregatedExport(date){
            const allShifts = JSON.parse(localStorage.getItem('shiftData') || '{}');
            const allHourly = JSON.parse(localStorage.getItem('hourlyData') || '{}');
            const shiftsOnDate = allShifts[date] || {};
            const hourlyOnDate = allHourly[date] || {};

            const store = getAggregatedStore();

            // shifts: dedupe by date+cuadrilla
            Object.keys(shiftsOnDate).forEach(cuadrilla => {
                const shift = shiftsOnDate[cuadrilla];
                if (!shift) return;
                const key = `${date}|${cuadrilla}`;
                const exists = store.shifts.some(s => s.key === key);
                if (!exists){
                    const extras = shift.extras || [];
                    const extrasSum = extras.reduce((s,e)=> s + parseFloat(e.hours || 0), 0);
                    store.shifts.push({
                        key, date, cuadrilla, coordinator: shift.coordinatorId || '', turno: shift.turno || getCurrentTurnoForCuadrilla(cuadrilla),
                        montas: shift.attendance ? shift.attendance.montas : '', alm: shift.attendance ? shift.attendance.alm : '', auditores: shift.attendance ? shift.attendance.auditores : '', auxiliares: shift.attendance ? shift.attendance.auxiliares : '', analistas: shift.attendance && shift.attendance.analistas ? shift.attendance.analistas : '',
                        metaTurno: shift.metaTurno || '', extrasJson: JSON.stringify(extras), extrasSum, comentarios: shift.comentarios || '', timestamp: shift.timestamp || ''
                    });
                }
            });

            // hourly: dedupe by date+cuadrilla+hour+coordinator
            Object.keys(hourlyOnDate).forEach(cuadrilla => {
                const entries = hourlyOnDate[cuadrilla] || [];
                entries.forEach(entry => {
                    const key = `${date}|${cuadrilla}|${entry.hour}|${entry.coordinatorId}`;
                    const exists = store.hourly.some(h => h.key === key);
                    if (!exists) {
                        store.hourly.push({key, date, cuadrilla, hour: entry.hour, cajas: entry.cajas, coordinator: entry.coordinatorId, timestamp: entry.timestamp || '', isLate: !!entry.isLate});
                    }
                });
            });

            store.lastUpdated = new Date().toISOString();
            setAggregatedStore(store);
            return store;
        }

        function exportAggregatedExcel(){
            const store = getAggregatedStore();
            if ((!store.shifts || store.shifts.length === 0) && (!store.hourly || store.hourly.length === 0)){
                alert('No hay datos en el archivo acumulado.');
                return;
            }

            const wb = XLSX.utils.book_new();
            // Build All_Shifts
            const shiftsSheet = [];
            shiftsSheet.push(['Fecha', 'Cuadrilla', 'Coordinador', 'Turno', 'Montas', 'Almacenistas', 'Auditores', 'Auxiliares', 'Analistas', 'MetaTurno', 'Extras (JSON)', 'Total Horas Extras', 'Comentarios', 'Timestamp']);
            store.shifts.forEach(s=>{
                shiftsSheet.push([s.date, s.cuadrilla === 'mixto' ? 'Turno Mixto' : (SYSTEM_CONFIG.cuadrillas[s.cuadrilla] ? SYSTEM_CONFIG.cuadrillas[s.cuadrilla].nombre : s.cuadrilla), s.coordinator, s.turno, s.montas, s.alm, s.auditores, s.auxiliares, s.analistas, s.metaTurno, s.extrasJson, s.extrasSum, s.comentarios, s.timestamp]);
            });
            const wsShifts = XLSX.utils.aoa_to_sheet(shiftsSheet);
            XLSX.utils.book_append_sheet(wb, wsShifts, 'All_Shifts');

            // Build All_Hourly
            const hourlySheet = [];
            hourlySheet.push(['Fecha', 'Cuadrilla', 'Hora', 'Cajas', 'Coordinador', 'Timestamp', 'Tard√≠o']);
            store.hourly.forEach(h=>{
                hourlySheet.push([h.date, h.cuadrilla === 'mixto' ? 'Turno Mixto' : (SYSTEM_CONFIG.cuadrillas[h.cuadrilla] ? SYSTEM_CONFIG.cuadrillas[h.cuadrilla].nombre : h.cuadrilla), `${h.hour}:00`, h.cajas, h.coordinator, h.timestamp, h.isLate ? 'S√≠' : 'No']);
            });
            const wsHourly = XLSX.utils.aoa_to_sheet(hourlySheet);
            XLSX.utils.book_append_sheet(wb, wsHourly, 'All_Hourly');

            const fileName = `export_completo_acumulado_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            alert('Exportaci√≥n acumulada descargada.');
            updateLastExportInfo();
        }

        function clearAggregatedExport(){
            if (!confirm('¬øDesea limpiar el archivo acumulado de exportaciones? Esta acci√≥n no se puede deshacer.')) return;
            localStorage.removeItem('aggregatedExport');
            alert('Archivo acumulado limpiado.');
        }
        
        function checkExistingSession() {
            // Check sessionStorage for active sessions (session-only mode)
            const savedUser = sessionStorage.getItem('currentUser');
            const savedType = sessionStorage.getItem('userType');
            if (savedUser && savedType) {
                loginUser(savedUser, savedType, false);
            }
        }

        // --- Admin Config Overrides ---
        function initAdminConfigUI(){
            // Load overrides if present
            const overrides = JSON.parse(localStorage.getItem('adminConfigOverrides') || '{}');
            // Fill values
            document.getElementById('admin-metaBase-turno-1').value = (overrides.turnos && overrides.turnos['1'] && overrides.turnos['1'].metaBase) ? overrides.turnos['1'].metaBase : SYSTEM_CONFIG.turnos['1'].metaBase;
            document.getElementById('admin-metaBase-turno-2').value = (overrides.turnos && overrides.turnos['2'] && overrides.turnos['2'].metaBase) ? overrides.turnos['2'].metaBase : SYSTEM_CONFIG.turnos['2'].metaBase;
            document.getElementById('admin-metaBase-turno-3').value = (overrides.turnos && overrides.turnos['3'] && overrides.turnos['3'].metaBase) ? overrides.turnos['3'].metaBase : SYSTEM_CONFIG.turnos['3'].metaBase;
            document.getElementById('admin-metaBase-turno-mixto').value = (overrides.turnos && overrides.turnos['mixto'] && overrides.turnos['mixto'].metaBase) ? overrides.turnos['mixto'].metaBase : SYSTEM_CONFIG.turnos['mixto'].metaBase;
            
            // Personal normal
            const normal = overrides.personal && overrides.personal.normal ? overrides.personal.normal : SYSTEM_CONFIG.personal.normal;
            document.getElementById('admin-target-normal-montacarguistas').value = normal.montacarguistas;
            document.getElementById('admin-target-normal-almacenistas').value = normal.almacenistas;
            document.getElementById('admin-target-normal-auditores').value = normal.auditores;
            document.getElementById('admin-target-normal-auxiliares').value = normal.auxiliares;
            
            // Personal mixto
            const mixto = overrides.personal && overrides.personal.mixto ? overrides.personal.mixto : SYSTEM_CONFIG.personal.mixto;
            document.getElementById('admin-target-mixto-montacarguistas').value = mixto.montacarguistas;
            document.getElementById('admin-target-mixto-almacenistas').value = mixto.almacenistas;
            document.getElementById('admin-target-mixto-auditores').value = mixto.auditores;
            document.getElementById('admin-target-mixto-auxiliares').value = mixto.auxiliares;
            document.getElementById('admin-target-mixto-analistas').value = mixto.analistas;

            // Attach events
            const saveBtn = document.getElementById('admin-save-config');
            const resetBtn = document.getElementById('admin-reset-config');
            if (saveBtn) saveBtn.addEventListener('click', saveAdminConfig);
            if (resetBtn) resetBtn.addEventListener('click', resetAdminConfig);
        }

        function saveAdminConfig(){
            const overrides = { turnos: {}, personal: { normal: {}, mixto: {} } };
            overrides.turnos['1'] = { metaBase: parseInt(document.getElementById('admin-metaBase-turno-1').value) || SYSTEM_CONFIG.turnos['1'].metaBase };
            overrides.turnos['2'] = { metaBase: parseInt(document.getElementById('admin-metaBase-turno-2').value) || SYSTEM_CONFIG.turnos['2'].metaBase };
            overrides.turnos['3'] = { metaBase: parseInt(document.getElementById('admin-metaBase-turno-3').value) || SYSTEM_CONFIG.turnos['3'].metaBase };
            overrides.turnos['mixto'] = { metaBase: parseInt(document.getElementById('admin-metaBase-turno-mixto').value) || SYSTEM_CONFIG.turnos['mixto'].metaBase };

            overrides.personal.normal.montacarguistas = parseInt(document.getElementById('admin-target-normal-montacarguistas').value) || SYSTEM_CONFIG.personal.normal.montacarguistas;
            overrides.personal.normal.almacenistas = parseInt(document.getElementById('admin-target-normal-almacenistas').value) || SYSTEM_CONFIG.personal.normal.almacenistas;
            overrides.personal.normal.auditores = parseInt(document.getElementById('admin-target-normal-auditores').value) || SYSTEM_CONFIG.personal.normal.auditores;
            overrides.personal.normal.auxiliares = parseInt(document.getElementById('admin-target-normal-auxiliares').value) || SYSTEM_CONFIG.personal.normal.auxiliares;

            overrides.personal.mixto.montacarguistas = parseInt(document.getElementById('admin-target-mixto-montacarguistas').value) || SYSTEM_CONFIG.personal.mixto.montacarguistas;
            overrides.personal.mixto.almacenistas = parseInt(document.getElementById('admin-target-mixto-almacenistas').value) || SYSTEM_CONFIG.personal.mixto.almacenistas;
            overrides.personal.mixto.auditores = parseInt(document.getElementById('admin-target-mixto-auditores').value) || SYSTEM_CONFIG.personal.mixto.auditores;
            overrides.personal.mixto.auxiliares = parseInt(document.getElementById('admin-target-mixto-auxiliares').value) || SYSTEM_CONFIG.personal.mixto.auxiliares;
            overrides.personal.mixto.analistas = parseInt(document.getElementById('admin-target-mixto-analistas').value) || SYSTEM_CONFIG.personal.mixto.analistas;

            // Persist overrides and apply
            localStorage.setItem('adminConfigOverrides', JSON.stringify(overrides));
            applyAdminOverridesToSystem(overrides);
            alert('Configuraci√≥n guardada.');
            // refresh views
            updateProgressView();
            updateAdminDashboard();
        }

        function applyAdminOverridesToSystem(overrides){
            if(!overrides) overrides = JSON.parse(localStorage.getItem('adminConfigOverrides') || '{}');
            if (overrides.turnos){
                Object.keys(overrides.turnos).forEach(k => {
                    if (SYSTEM_CONFIG.turnos[k]) SYSTEM_CONFIG.turnos[k].metaBase = overrides.turnos[k].metaBase;
                });
            }
            if (overrides.personal){
                if (overrides.personal.normal) Object.assign(SYSTEM_CONFIG.personal.normal, overrides.personal.normal);
                if (overrides.personal.mixto) Object.assign(SYSTEM_CONFIG.personal.mixto, overrides.personal.mixto);
            }
            // Refresh UI to reflect updated HC Targets
            updateHCTargetDisplays();
        }

        function updateHCTargetDisplays() {
            const elMontas = document.getElementById('montas-target');
            const elAlm = document.getElementById('alm-target');
            const elAud = document.getElementById('auditores-target');
            const elAux = document.getElementById('auxiliares-target');
            const elAnal = document.getElementById('analistas-target');
            const useMixto = currentTurno === 'mixto' || isMixto;
            const source = useMixto ? SYSTEM_CONFIG.personal.mixto : SYSTEM_CONFIG.personal.normal;
            if (elMontas) elMontas.textContent = source.montacarguistas || 0;
            if (elAlm) elAlm.textContent = source.almacenistas || 0;
            if (elAud) elAud.textContent = source.auditores || 0;
            if (elAux) elAux.textContent = source.auxiliares || 0;
            if (elAnal) elAnal.textContent = (useMixto ? (SYSTEM_CONFIG.personal.mixto.analistas || 0) : 0);
        }

        function resetAdminConfig(){
            if (!confirm('Restablecer√° valores por defecto de metas y targets. ¬øDesea continuar?')) return;
            // Remove overrides
            localStorage.removeItem('adminConfigOverrides');
            // Restore from default
            Object.keys(DEFAULT_SYSTEM_CONFIG.turnos).forEach(k => {
                if (SYSTEM_CONFIG.turnos[k]) SYSTEM_CONFIG.turnos[k].metaBase = DEFAULT_SYSTEM_CONFIG.turnos[k].metaBase;
            });
            SYSTEM_CONFIG.personal = JSON.parse(JSON.stringify(DEFAULT_SYSTEM_CONFIG.personal));
            initAdminConfigUI();
            updateProgressView();
            updateAdminDashboard();
            updateHCTargetDisplays();
            alert('Valores restablecidos a los predeterminados.');
        }
        
        function logout() {
            currentUser = null;
            userType = null;
            isMixto = false;
            currentCuadrilla = null;
            currentShiftData = null;
            
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userType');
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('userType');
            // Clean any leftover flags (if any)
            try { sessionStorage.removeItem('authRemember'); localStorage.removeItem('authRemember'); } catch (e) {}
            
            document.getElementById('main-system').style.display = 'none';
            document.getElementById('login-screen').style.display = 'block';
            
            document.getElementById('user-id').value = '';
            document.getElementById('password').value = '';
            // If using Firebase auth, also sign out there
            try { if (window.firebaseInitialized && window.auth) window.auth.signOut(); } catch (e) { console.warn('firebase signOut failed', e); }
        }
    </script>
</body>
</html>