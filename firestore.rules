rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función para obtener datos del usuario actual
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Función para verificar si es admin
    function isAdmin() {
      return request.auth != null && getUserData().role == 'admin';
    }
    
    // Función para verificar si es coordinador
    function isCoordinator() {
      return request.auth != null && getUserData().role == 'coordinator';
    }
    
    // Función para verificar si pertenece a la misma cuadrilla
    function isSameCuadrilla(cuadrilla) {
      return request.auth != null && getUserData().cuadrilla == cuadrilla;
    }

    // COLECCIÓN: users - Información de usuarios
    match /users/{userId} {
      // Lectura: Los usuarios pueden leer su propio documento y admins pueden leer todos
      allow read: if request.auth.uid == userId || isAdmin();
      
      // Escritura: Solo admins pueden crear/actualizar usuarios
      allow create: if isAdmin() && request.resource.data.role in ['admin', 'coordinator']
                     && request.resource.data.cuadrilla != null;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // COLECCIÓN: shifts - Turnos diarios registrados
    match /shifts/{date}/cuadrillas/{cuadrilla} {
      // Lectura: Coordinadores leen su cuadrilla, admins leen todo
      allow read: if isCoordinator() && isSameCuadrilla(cuadrilla) || isAdmin();
      
      // Escritura: Coordinadores escriben solo su cuadrilla, admins pueden escribir todo
      allow create, update: if (isCoordinator() && isSameCuadrilla(cuadrilla) && 
                                request.resource.data.coordinatorId == request.auth.uid)
                             || isAdmin();
      allow delete: if isAdmin();
    }

    // Permitir lectura de toda la fecha (agregado)
    match /shifts/{date} {
      allow read: if isAdmin() || isCoordinator();
    }

    // COLECCIÓN: hourly - Registros horarios de producción
    match /hourly/{date}/cuadrillas/{cuadrilla} {
      // Lectura: Coordinadores leen su cuadrilla, admins leen todo
      allow read: if isCoordinator() && isSameCuadrilla(cuadrilla) || isAdmin();
      
      // Escritura: Coordinadores escriben datos de su cuadrilla
      allow create, update: if (isCoordinator() && isSameCuadrilla(cuadrilla) && 
                                request.resource.data.coordinatorId == request.auth.uid)
                             || isAdmin();
      allow delete: if isAdmin();
    }

    // Permitir lectura de toda la fecha
    match /hourly/{date} {
      allow read: if isAdmin() || isCoordinator();
    }

    // COLECCIÓN: logs - Auditoría de cambios
    match /logs/{logId} {
      // Lectura: Solo admins
      allow read: if isAdmin();
      
      // Escritura: Cualquier usuario autenticado puede escribir logs (auditoría)
      allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.timestamp == request.time;
      
      allow update, delete: if isAdmin();
    }

    // COLECCIÓN: config - Configuración del sistema (metas, personal, etc)
    match /config/{document=**} {
      // Lectura: Todos los usuarios autenticados pueden leer
      allow read: if request.auth != null;
      
      // Escritura: Solo admins
      allow write: if isAdmin();
    }

    // COLECCIÓN: coordinadores - Información de coordinadores por cuadrilla
    match /coordinadores/{cuadrilla} {
      // Lectura: Todos los autenticados
      allow read: if request.auth != null;
      
      // Escritura: Solo admins
      allow write: if isAdmin();
    }

    // COLECCIÓN: reports - Reportes generados
    match /reports/{reportId} {
      // Lectura: Admins leen todos, coordinadores solo los suyos
      allow read: if isAdmin() || (isCoordinator() && resource.data.generatedBy == request.auth.uid);
      
      // Escritura: Solo admins y cloud functions pueden crear reportes
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Denegar todo por defecto
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
